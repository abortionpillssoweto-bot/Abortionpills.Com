<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SA Abortion Pills Delivery</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="SA Pills">
    <meta name="theme-color" content="#e41e26">
    
    <link rel="apple-touch-icon" href="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg">
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22SA%20Abortion%20Pills%22,%22short_name%22:%22SA%20Pills%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#ffffff%22,%22theme_color%22:%22#e41e26%22,%22icons%22:[{%22src%22:%22https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg%22,%22sizes%22:%22192x192%22,%22type%22:%22image/jpg%22}]}">

    <style>
        :root { --primary: #e41e26; --blue: #00529B; --green: #25D366; --dark: #222; --orange: #ff9800;}
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; padding-bottom: 320px; -webkit-tap-highlight-color: transparent; }
        
        #age-gate, #role-selection {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); color: white; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; text-align: center; padding: 20px; box-sizing: border-box;
        }
        #role-selection { background: #fff; color: #333; display: none; }

        .gate-btn { width: 100%; max-width: 280px; padding: 18px; margin: 10px; border-radius: 12px; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .role-card { background: #f8f8f8; border: 2px solid #eee; color: var(--dark); margin: 10px; width: 100%; max-width: 300px; padding: 20px; border-radius: 15px; cursor: pointer; }
        .role-card:hover { border-color: var(--primary); background: #fff5f5; }

        header { background: var(--primary); color: white; padding: 15px; text-align: center; padding-top: 30px; }
        .nav-tabs { display: flex; background: white; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; }
        .active-tab { border-bottom: 4px solid var(--primary); color: var(--primary); background: #fff5f5; }

        .container { padding: 15px; }
        .card { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding-bottom:10px; }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-content { padding: 15px; }
        
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .add-btn { background: var(--primary); color: white; border: none; font-weight: bold; }
        .whatsapp-btn { background: var(--green); color: white; border: none; font-weight: bold; padding: 15px; font-size: 1.1rem; }
        .app-btn { background: var(--blue); color: white; border: none; font-weight: bold; padding: 15px; font-size: 1.1rem; margin-top: 10px; }

        .tracking-bar { background: #eee; height: 10px; border-radius: 5px; margin: 20px 0; overflow: hidden; }
        .tracking-progress { background: var(--green); height: 100%; width: 5%; transition: width 1s; }

        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border-radius: 15px; width: 85%; text-align: center; max-height: 80vh; overflow-y: auto; }
        .modal-btn { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 8px; margin: 5px; font-weight: bold; width: 100%; }

        #admin-page, #driver-page { display: none; }
        .driver-card { background: #fff; padding: 15px; margin-top: 12px; border-radius: 10px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 8px solid var(--blue); }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; text-transform: uppercase; margin-top: 5px; }
        
        .order-card { background: #fffbe6; padding: 15px; margin-bottom: 15px; border: 2px solid #ffd54f; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .delivery-card { background: #e3f2fd; padding: 15px; margin-bottom: 15px; border: 2px solid #2196f3; border-radius: 8px; }
        .del-btn { background: #fee; color: #c00; border: 1px solid #fcc; font-size: 11px; padding: 5px; margin-top: 10px; cursor: pointer; border-radius: 4px; width: auto; display: inline-block; }
        
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0px rgba(37, 211, 102, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(37, 211, 102, 0); }
            100% { box-shadow: 0 0 0 0px rgba(37, 211, 102, 0); }
        }
        .new-task-highlight { animation: pulse-border 2s infinite; border: 3px solid var(--green) !important; }

        .float-chat {
            position: fixed; bottom: 180px; right: 20px; background: var(--green);
            color: white; width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; text-decoration: none;
            font-size: 30px; font-weight: bold;
        }

        .cart-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        .cart-del { color: var(--primary); border: none; background: none; width: auto; padding: 0; margin: 0; font-size: 12px; cursor: pointer; font-weight: bold; }
        .order-summary-box { background: #fffde7; padding: 10px; border-radius: 8px; border: 1px solid #ffd54f; margin: 10px 0; font-size: 0.9rem; }
        
        .assign-area { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; }
        
        #install-banner {
            display: none; position: fixed; bottom: 20px; left: 10px; right: 10px;
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 10001;
            border-top: 4px solid var(--primary);
        }
        .forgot-link { font-size: 14px; color: var(--blue); text-decoration: underline; cursor: pointer; display: block; margin-top: 10px; }

        /* PROFESSIONAL NOTIFICATION UI - UPDATED */
        #verifyNotify {
            display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 400px; background: white; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); border-radius: 16px; z-index: 20000;
            padding: 20px; animation: slideDown 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border-top: 5px solid var(--primary);
            pointer-events: auto;
        }
        @keyframes slideDown { from { top: -150px; opacity: 0; } to { top: 20px; opacity: 1; } }
        .verify-pin-box { background: #f0f0f0; font-size: 24px; font-weight: bold; text-align: center; padding: 15px; margin: 15px 0; border-radius: 12px; border: 2px dashed var(--blue); letter-spacing: 4px; color: var(--blue); position: relative; }
        .copy-tag { position: absolute; right: 8px; bottom: 4px; font-size: 9px; color: var(--green); font-weight: bold; }

        /* DRIVER SPECIFIC BUTTONS */
        .driver-action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-arrive { background: var(--orange); color: white; border: none; font-weight: bold; padding: 16px; border-radius: 8px; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3); cursor: pointer; }
        .btn-delivered { background: var(--green); color: white; border: none; font-weight: bold; padding: 12px; border-radius: 8px; }
        .btn-failed { background: var(--primary); color: white; border: none; font-weight: bold; padding: 12px; border-radius: 8px; }

        /* APPROVAL CARD */
        .approval-card { background: #fff5f5; border: 1px solid var(--primary); padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        
        /* NEW DEBT STYLES */
        .debt-alert { background: #fff3f3; border: 2px solid #f44336; padding: 20px; border-radius: 15px; text-align: center; margin-top: 20px; }
        .debt-amount { font-size: 2rem; font-weight: bold; color: #f44336; margin: 10px 0; }

        /* INJECTED TIMER CIRCLE STYLES */
        .timer-container { display: none; flex-direction: column; align-items: center; margin: 20px 0; }
        .timer-circle {
            width: 120px; height: 120px; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 8px solid #eee; transition: all 0.5s ease;
            background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .timer-val { font-size: 1.4rem; font-weight: bold; color: #333; }
        .timer-label { font-size: 10px; text-transform: uppercase; color: #666; margin-top: 4px; }
        .timer-green { border-color: var(--green); color: var(--green); }
        .timer-yellow { border-color: var(--orange); color: var(--orange); }
        .timer-red { border-color: var(--primary); color: var(--primary); }

        /* POP VIEW STYLES */
        .pop-preview { max-width: 100%; border-radius: 10px; margin-top: 10px; border: 2px solid #ddd; display: none; }
        .balance-box { background: #fffbe6; border: 2px dashed var(--orange); padding: 15px; border-radius: 10px; margin-top: 10px; text-align: center; }
    </style>
</head>
<body onload="checkAutoLogin()">

<div id="verifyNotify">
    <div style="display:flex; align-items:center; gap:15px; margin-bottom: 15px;">
        <div id="notifyIcon" style="background:var(--primary); color:white; width:45px; height:45px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size: 24px;">üîî</div>
        <div style="flex:1;">
            <strong id="notifyHeader" style="font-size: 1.1rem; color: #333;">System Alert</strong><br>
            <span id="notifySub" style="color:#666; font-size: 14px; line-height: 1.4;">Notification details here.</span>
        </div>
        <button onclick="closeVerifyNotify()" style="border:none; background:#eee; width:30px; height:30px; border-radius:50%; font-size:18px; color:#666; cursor:pointer;">√ó</button>
    </div>
    
    <div id="forgotPinInputArea" style="margin-top:10px; display:none;">
        <input type="tel" id="forgotPhoneInput" placeholder="Enter Registered Phone Number">
        <button onclick="requestQualificationCode()" style="background:var(--blue); color:white; border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold;">GET QUALIFICATION CODE</button>
    </div>

    <div id="otpVerifyArea" style="margin-top:10px; display:none;">
        <p style="font-size:13px; color:var(--primary);">Admin will send your code via WhatsApp. Enter it below:</p>
        <input type="number" id="otpCodeInput" placeholder="Enter 6-Digit Code">
        <button onclick="verifyQualificationCode()" style="background:var(--green); color:white; border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold;">VERIFY & RECOVER PIN</button>
    </div>

    <div class="verify-pin-box" id="pinOutput" style="display:none;" onclick="copyPin()">
        0000
        <span class="copy-tag">TAP TO COPY</span>
    </div>
    <button id="notifyActionBtn" onclick="closeVerifyNotify()" style="display:none; background:var(--primary); color:white; border:none; padding:14px; width:100%; border-radius:10px; font-weight:bold; font-size:1rem; cursor:pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">DISMISS ALERT</button>
</div>

<div id="install-banner">
    <div style="display:flex; align-items:center; gap:10px;">
        <img src="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg" width="50" style="border-radius:8px;">
        <div>
            <strong>Install App</strong><br>
            <small>Add to your home screen for fast access.</small>
        </div>
    </div>
    <button class="add-btn" id="install-btn" style="margin-top:10px;">INSTALL NOW</button>
</div>

<div id="age-gate">
    <h1 style="color:var(--primary);">STOP</h1>
    <h2>AGE VERIFICATION</h2>
    <p>This service is strictly for people aged 18 and older.</p>
    <button class="gate-btn" style="background:var(--green); color:white;" onclick="verifyAge()">YES, I AM 18+</button>
    <button class="gate-btn" style="background:var(--primary); color:white;" onclick="exitSite()">NO, EXIT</button>
</div>

<div id="role-selection">
    <h2 style="color:var(--primary); margin-bottom:5px;">SA Delivery Portal</h2>
    <p style="margin-bottom:25px;">Please select your role to continue</p>
    
    <div class="role-card" onclick="selectRole('customer')">
        <h3 style="margin:0; color:var(--primary);">üõçÔ∏è Customer</h3>
        <small>Order pills & track delivery</small>
    </div>

    <div class="role-card" onclick="selectRole('driver')">
        <h3 style="margin:0; color:var(--blue);">üöö Driver</h3>
        <small>Login or Registration as a Driver</small>
    </div>

    <div class="role-card" onclick="selectRole('admin')">
        <h3 style="margin:0; color:var(--dark);">‚öôÔ∏è Admin / Staff</h3>
        <small>Management & Dispatch</small>
    </div>
</div>

<header>
    <h1>SA Abortion Pills Delivery</h1>
    <p>Fast Delivery to Villages & Cities</p>
</header>

<a href="https://wa.me/27632010938?text=Hi, I need help with my order." class="float-chat" target="_blank">üí¨</a>

<div class="nav-tabs">
    <div class="tab active-tab" id="tab-shop-btn" onclick="showPage('shop')">Menu</div>
    <div class="tab" id="tab-check-btn" onclick="showPage('checkout')">My Cart</div>
    <div class="tab" id="tab-track-btn" style="display:none;" onclick="showPage('tracking')">Track Order</div>
    <div class="tab" onclick="switchRoleManual()">Switch Role</div>
</div>

<div id="shop-page" class="container">
    <div class="card"><img src="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg"><div class="card-content"><h3>1 Week - 4 Weeks Pills</h3><div style="color:var(--blue); font-weight:bold; font-size:1.2rem;">R 650.00</div><button class="add-btn" onclick="addToCart('1-4 Weeks Pills', 650)">Add to Order</button></div></div>
    <div class="card"><img src="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg"><div class="card-content"><h3>2 Months Pills</h3><div style="color:var(--blue); font-weight:bold; font-size:1.2rem;">R 750.00</div><button class="add-btn" onclick="addToCart('2 Months Pills', 750)">Add to Order</button></div></div>
    <div class="card"><img src="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg"><div class="card-content"><h3>3 Months Pills</h3><div style="color:var(--blue); font-weight:bold; font-size:1.2rem;">R 950.00</div><button class="add-btn" onclick="addToCart('3 Months Pills', 950)">Add to Order</button></div></div>
    <div class="card"><img src="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg"><div class="card-content"><h3>4 Months Pills</h3><div style="color:var(--blue); font-weight:bold; font-size:1.2rem;">R 1200.00</div><button class="add-btn" onclick="addToCart('4 Months Pills', 1200)">Add to Order</button></div></div>
</div>

<div id="checkout-page" class="container" style="display:none;">
    <div class="card" style="padding:15px;">
        <h3 style="color:var(--primary); margin-top:0;">Your Selection</h3>
        <div id="cart-list">Your cart is empty.</div>
        <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
        <h3 style="color:var(--primary);">Delivery Details</h3>
        <select id="province" onchange="updateVillages('village')">
            <option value="">-- Choose Province --</option>
            <option value="Gauteng">Gauteng</option>
            <option value="North West">North West</option>
            <option value="Free State">Free State</option>
            <option value="Western Cape">Western Cape</option>
            <option value="KZN">KZN</option>
        </select>
        <select id="village"><option value="">-- Area --</option></select>
        <input type="text" id="custName" placeholder="Your Full Name">
        <input type="tel" id="custPhone" placeholder="Phone Number (WhatsApp)">
        <input type="text" id="custAddress" placeholder="Full Delivery Address">
        <select id="payMethod">
            <option value="Cash on Delivery">Cash on Delivery</option>
            <option value="Capitec Bank">Capitec Transfer (2033037351)</option>
        </select>
    </div>
</div>

<div id="tracking-page" class="container" style="display:none;">
    <div id="tracking-content" class="card" style="padding:15px;">
        <h3 style="color:var(--blue);">Live Order Status</h3>
        
        <div id="orderTimer" class="timer-container">
            <div id="timerCircle" class="timer-circle">
                <div id="timerDisplay" class="timer-val">00:00</div>
                <div id="timerLabel" class="timer-label">Waiting</div>
            </div>
            <p id="timerMessage" style="font-size: 11px; color: #777; margin-top: 8px; font-weight: bold;"></p>
        </div>

        <div id="tracking-order-number" style="font-weight:bold; color:var(--primary); margin-bottom:10px;">Order ID: Loading...</div>
        <div id="order-items-summary" class="order-summary-box">Loading order details...</div>
        
        <div id="tracking-cancelled-notice" style="display:none; background:#fee; border:2px solid #fcc; padding:15px; border-radius:10px; margin-bottom:15px; text-align:center;">
            <strong style="color:#c00;">üö´ UPDATE FROM ADMIN</strong><br>
            <p id="cancel-reason-display" style="font-size:14px; margin:10px 0; font-weight:bold;"></p>
            
            <div class="balance-box">
                <p style="font-size:13px; margin-bottom:10px;">How would you like to proceed?</p>
                <button onclick="switchOrderToCOD()" style="background:var(--orange); color:white; border:none; padding:10px; border-radius:5px; width:100%; font-weight:bold; margin-bottom:8px;">PAY BALANCE VIA CASH ON DELIVERY</button>
                <button onclick="document.getElementById('pop-upload-input').click()" style="background:var(--blue); color:white; border:none; padding:10px; border-radius:5px; width:100%; font-weight:bold;">PAY BALANCE & UPLOAD NEW POP</button>
            </div>

            <button onclick="returnToMenu()" style="background:#eee; color:#333; padding:10px; width:100%; border-radius:5px; border:none; margin-top:15px;">Order Again / Return Home</button>
        </div>

        <div id="tracking-payment-notice" style="display:none; background:#fff3e0; border:2px solid #ff9800; padding:15px; border-radius:10px; margin-bottom:15px;">
            <strong style="color:#e65100;">‚ö†Ô∏è ACTION REQUIRED: PAYMENT</strong><br>
            <span style="font-size:13px;">Please upload your Capitec transfer Proof of Payment (Screenshot) below to start delivery.</span>
            
            <input type="file" id="pop-upload-input" accept="image/*" style="display:none" onchange="handlePopUpload(this)">
            <button onclick="document.getElementById('pop-upload-input').click()" style="background:var(--blue); color:white; border:none; padding:12px; margin-top:10px; width:100%; border-radius:5px; font-weight:bold;">UPLOAD POP SCREENSHOT</button>
            
            <div id="pop-success-msg" style="display:none; color:var(--green); font-weight:bold; margin-top:10px; font-size:12px;">‚úÖ POP Uploaded to System! Waiting for Admin.</div>
        </div>

        <div id="tracking-active-ui">
            <p id="status-text"><strong>Status:</strong> Processing Order...</p>
            <div class="tracking-bar"><div id="progress-line" class="tracking-progress"></div></div>
            
            <div id="driver-info" style="margin-top:20px; padding:15px; border:2px solid var(--blue); border-radius:8px; display:none; background: #f0f7ff;">
                <p><strong>üöö Your Order is being delivered by:</strong></p>
                <p style="font-size: 1.1rem; margin-bottom: 5px;"><strong id="assigned-driver-name">Searching...</strong></p>
                <p><strong>üìû Driver Phone:</strong> <span id="assigned-driver-phone-display" style="font-weight:bold;">---</span></p>
                
                <a id="cust-to-driver-wa" href="#" target="_blank" style="text-decoration:none;">
                    <button style="background:var(--green); color:white; border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold; margin:10px 0; cursor:pointer;">
                        üí¨ CHAT WITH DRIVER (WhatsApp)
                    </button>
                </a>

                <p id="driver-received-msg" style="color:var(--green); font-weight:bold; font-size: 13px; display:none;">‚úÖ Driver has acknowledged your order!</p>
                <hr>
                <button onclick="finishOrder()" style="background:var(--green); color:white; border:none; padding:15px; width:100%; border-radius:8px; font-weight:bold; cursor:pointer;">Order Delivered ‚úÖ</button>
            </div>
        </div>
    </div>

    <div id="order-complete-view" class="card" style="padding:30px; display:none; text-align:center;">
        <h2 style="color:var(--green);">Order Completed! üéâ</h2>
        <p>Thank you for using our service. Your order has been successfully delivered.</p>
        <button onclick="returnToMenu()" style="background:var(--blue); color:white; border:none; padding:15px; width:100%; border-radius:8px; font-weight:bold; cursor:pointer;">Order Now / Return Home</button>
    </div>
</div>

<div id="admin-page" class="container">
    <button onclick="switchRoleManual()" style="background:#444; color:white;">‚Üê Back to Selection</button>
    <h2 style="color:var(--primary);">Admin Dashboard</h2>

    <h3 style="color:var(--blue);">üí∞ Pending Capitec Payments</h3>
    <div id="admin-pending-payments" style="background:#e3f2fd; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid #2196f3;">
        Checking for customer payments...
    </div>

    <h3 style="color:var(--orange);">Verification Requests (Forgot PIN)</h3>
    <div id="admin-verify-requests" style="background:#fffbe6; padding:15px; border:1px solid #ffe58f; border-radius:12px; margin-bottom:20px;">
        Checking for verification requests...
    </div>

    <h3 style="color:var(--primary);">0. Driver Cash Settlements</h3>
    <div id="debt-clearance-list" style="background:#e8f5e9; padding:15px; border-radius:10px; border:1px solid var(--green); margin-bottom:20px;">
        Checking for payments...
    </div>
    
    <h3 style="color:var(--primary);">1. New Customer Orders</h3>
    <div id="live-orders-list">No new orders.</div>
    <hr>
    
    <h3 style="color:var(--blue);">2. Active Deliveries (En Route)</h3>
    <div id="active-deliveries-list" style="background:#fff; border-radius:10px; padding:10px; border:1px solid #ddd;">Looking for active deliveries...</div>
    <hr>

    <h3 style="color:var(--orange);">3. Driver Approval Requests</h3>
    <div id="driver-approval-list" style="background:#fff3e0; padding:10px; border-radius:10px;">Checking for requests...</div>
    <hr>
    
    <h3 style="color:var(--dark);">4. Driver Management</h3>
    <div style="background:#f0f7ff; padding:15px; border-radius:10px; border:1px solid #cce3ff;">
        <input type="text" id="driverName" placeholder="Manual Add Driver Name">
        <input type="text" id="driverPhone" placeholder="WhatsApp Number">
        <select id="adminProvince" onchange="updateVillages('adminVillage')">
            <option value="">-- Province --</option>
            <option value="Gauteng">Gauteng</option>
            <option value="North West">North West</option>
            <option value="Free State">Free State</option>
            <option value="Western Cape">Western Cape</option>
            <option value="KZN">KZN</option>
        </select>
        <select id="adminVillage"><option value="">-- Area --</option></select>
        <button onclick="saveDriver()" style="background:var(--green); color:white; font-weight:bold;">Register Driver</button>
    </div>
    <div id="driver-list" style="margin-top: 20px;"></div>
</div>

<div id="driver-page" class="container">
    <button onclick="driverLogout()" style="background:#444; color:white;">‚Üê Logout</button>
    <h2 style="color:var(--blue);">Driver Portal</h2>
    
    <p>Welcome, <span id="portal-driver-name">Driver</span></p>

    <div id="driver-debt-screen" class="debt-alert" style="display:none;">
        <h2 style="margin-top:0;">üõë PAYMENT REQUIRED</h2>
        <p>You delivered a Cash on Delivery order. You must pay 50% of the item price to Admin to continue.</p>
        <div class="debt-amount" id="pending-debt-display">R 0.00</div>
        <div style="background:white; padding:15px; border-radius:10px; text-align:left; border:1px solid #ddd;">
            <strong>BANK DETAILS:</strong><br>
            Bank: Capitec<br>
            Account: 2033037351<br>
            Reference: Your Name
        </div>
        
        <input type="file" id="driver-debt-upload" accept="image/*" style="display:none" onchange="handleDriverPopUpload(this)">
        <button onclick="document.getElementById('driver-debt-upload').click()" style="background:var(--blue); color:white; font-weight:bold; margin-bottom:10px;">UPLOAD SETTLEMENT SLIP (IMAGE)</button>
        
        <div id="driver-pop-success" style="display:none; color:var(--green); font-weight:bold; margin-bottom:15px;">‚úÖ Slip Sent to Admin!</div>

        <button onclick="window.open('https://wa.me/27632010938?text=I have paid my delivery commission. Here is the proof.', '_blank')" style="background:var(--green); color:white; font-weight:bold;">SEND PROOF VIA WHATSAPP</button>
    </div>

    <div id="assigned-task-card" class="card" style="padding:15px; border-left: 10px solid var(--green); display:none;">
        <h3 style="color:var(--green);">Active Task</h3>
        <div id="task-details"></div>
        
        <button id="driver-acknowledge-btn" style="background:var(--blue); color:white; margin-bottom:10px;">üì≤ Accept Order</button>
        <button id="driver-reject-btn" style="background:var(--primary); color:white; margin-bottom:10px;">‚Ü©Ô∏è Return to Admin</button>
        
        <button id="driver-arrive-btn" class="btn-arrive" style="display:none; width:100%; margin-bottom:10px;" onclick="notifyArrival()">üöÄ I HAVE ARRIVED</button>
        
        <div id="delivery-final-actions" style="display:none;" class="driver-action-grid">
            <button class="btn-delivered" onclick="processDriverDelivery('delivered')">‚úÖ DELIVERED</button>
            <button class="btn-failed" onclick="processDriverDelivery('failed')">‚ùå NOT DELIVERED</button>
        </div>

        <button id="map-link-btn" style="background:var(--blue); color:white;">üìç Open in Google Maps</button>
        <p style="font-size:12px; color:#666; margin-top:10px;">Contact Customer via WhatsApp:</p>
        <button id="cust-whatsapp-btn" style="background:var(--green); color:white;">üí¨ Chat with Customer</button>
    </div>

    <div id="no-task-msg" style="text-align:center; padding:50px; color:#999;">
        <h3>No active tasks.</h3>
        <p>Refresh this page when you receive a notification.</p>
    </div>
</div>

<div id="footer-controls" style="position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); box-sizing: border-box; z-index: 500; display: none;">
    <div id="cart-total" style="font-weight: bold; margin-bottom: 10px; font-size: 1.1rem;">Total: R 0.00</div>
    <button class="whatsapp-btn" style="width:100%;" onclick="sendOrder()">Confirm Order via WhatsApp</button>
    <button class="app-btn" style="width:100%;" onclick="orderViaApp()">Order Now</button>
</div>

<div id="customModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--primary);">Added!</h3>
        <button class="modal-btn" onclick="showPage('checkout'); closeModal();">Go to My Cart</button>
        <button class="modal-btn" style="background:#eee; color:#333;" onclick="closeModal()">Continue Shopping</button>
    </div>
</div>

<div id="loginModal" class="modal">
    <div class="modal-content">
        <h3 id="loginTitle">Portal Login</h3>
        <input type="tel" id="loginPhoneInput" placeholder="WhatsApp Phone Number">
        <input type="password" id="adminPinInput" placeholder="Enter Login PIN">
        <button class="modal-btn" onclick="checkAdminLogin()">Login Securely</button>
        
        <div id="customerRegArea" style="display:none; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px;">
            <p>Don't have a PIN?</p>
            <button class="modal-btn" style="background:var(--blue);" onclick="openRegisterModal()">Register for Account</button>
        </div>
        
        <span class="forgot-link" onclick="forgotPin()">Forgot PIN / Password?</span>
        <button class="modal-btn" style="background:#eee; color:#333;" onclick="closeLoginModal()">Cancel</button>
    </div>
</div>

<div id="registerModal" class="modal">
    <div class="modal-content">
        <h3 id="regTitle">Registration</h3>
        <p id="regInfo" style="font-size:12px; color:gray;">After registering, Admin must approve your account.</p>
        <input type="text" id="regDriverName" placeholder="Full Name">
        <input type="tel" id="regDriverPhone" placeholder="WhatsApp Phone Number">
        <input type="password" id="regDriverPin" placeholder="Create a 4-Digit PIN">

        <div id="areaRegGroup">
            <select id="regProvince" onchange="updateVillages('regVillage')">
                <option value="">-- Province --</option>
                <option value="Gauteng">Gauteng</option>
                <option value="North West">North West</option>
                <option value="Free State">Free State</option>
                <option value="Western Cape">Western Cape</option>
                <option value="KZN">KZN</option>
            </select>
            <select id="regVillage"><option value="">-- Area --</option></select>
        </div>
        
        <button id="requestPinBtn" class="modal-btn" style="background:var(--green);" onclick="submitRegistration()">Submit Registration</button>
        <button class="modal-btn" style="background:#eee; color:#333;" onclick="closeRegisterModal()">Cancel</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
    // --- APP CORE CONFIG ---
    let notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
    let soundEnabled = false;
    let alarmInterval = null;

    // INJECTED TIMER VARIABLES
    let orderTimerInterval = null;

    document.addEventListener('click', () => {
        if(!soundEnabled) {
            notificationSound.play().then(() => {
                notificationSound.pause();
                soundEnabled = true;
            }).catch(e => console.log("Sound ready..."));
        }
    }, { once: true });

    function triggerAlert() {
        if (soundEnabled) {
            notificationSound.currentTime = 0;
            notificationSound.play();
            if (alarmInterval) clearInterval(alarmInterval);
            let playCount = 1; 
            alarmInterval = setInterval(() => {
                notificationSound.currentTime = 0;
                notificationSound.play();
                playCount++;
                if (playCount >= 2) {
                    clearInterval(alarmInterval);
                    alarmInterval = null;
                }
            }, 3000); 
        }
        if ("vibrate" in navigator) {
            navigator.vibrate([300, 100, 300, 100, 300]);
        }
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBbmHfC_SvrT4YPkxeaIxF1X-E0JQ_Gl1U",
      authDomain: "sa-abortion-pills.firebaseapp.com",
      databaseURL: "https://sa-abortion-pills-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sa-abortion-pills",
      storageBucket: "sa-abortion-pills.firebasestorage.app",
      messagingSenderId: "1026604792208",
      appId: "1:1026604792208:web:3d1a993e25e0b6c25d9b15",
      measurementId: "G-LPFPFN9J0S"
    };

    if (firebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE") {
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    }
    
    const database = firebase.database();

    let cart = [];
    let allDrivers = [];
    let loggedInDriverPhone = null;
    let currentRoleType = 'customer';
    let generatedPin = "";
    let activeTaskID = null;
    let currentQualificationCode = "";
    let recoveryUserPhone = "";

    // --- PRO INJECTED LOGIC ---

    function startCountdown(durationSeconds, label, isOrderWait = false) {
        clearInterval(orderTimerInterval);
        const container = document.getElementById('orderTimer');
        const circle = document.getElementById('timerCircle');
        const display = document.getElementById('timerDisplay');
        const labelEl = document.getElementById('timerLabel');
        const msgEl = document.getElementById('timerMessage');

        container.style.display = 'flex';
        labelEl.innerText = label;
        msgEl.innerText = isOrderWait ? "Wait for Admin to give order to driver" : "Driver is on the way - arriving within 1hr 30min";

        let remaining = durationSeconds;
        
        const updateUI = () => {
            const m = Math.floor(remaining / 60);
            const s = remaining % 60;
            display.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;

            circle.classList.remove('timer-green', 'timer-yellow', 'timer-red');
            let percentage = (remaining / durationSeconds) * 100;
            if (percentage > 50) circle.classList.add('timer-green');
            else if (percentage > 20) circle.classList.add('timer-yellow');
            else circle.classList.add('timer-red');

            if (remaining <= 0) {
                clearInterval(orderTimerInterval);
                display.innerText = "READY";
            }
            remaining--;
        };

        updateUI();
        orderTimerInterval = setInterval(updateUI, 1000);
    }

    function processDriverDelivery(status) {
        if(!activeTaskID) return;
        database.ref('orders/' + activeTaskID).once('value', snap => {
            const order = snap.val();
            if(status === 'delivered' && order.payment === 'Cash on Delivery') {
                let cleanTotal = order.total.replace(/[^0-9.]/g, '');
                let debt = (parseFloat(cleanTotal) / 2).toFixed(2);
                database.ref('drivers/' + loggedInDriverPhone).update({ currentStatus: 'unpaid_debt', pendingDebt: debt });
                database.ref('orders/' + activeTaskID).update({ status: status });
                showAppNotify("Payment Required", `Order Complete. You must pay R${debt} commission to Admin to continue.`, "var(--primary)");
            } else { updateDeliveryStatus(status); }
        });
    }

    function fetchDebtRequests() {
        const div = document.getElementById('debt-clearance-list');
        database.ref('drivers').on('value', snap => {
            div.innerHTML = "";
            let count = 0;
            snap.forEach(child => {
                const d = child.val();
                if(d.currentStatus === 'unpaid_debt') {
                    count++;
                    let slipHtml = d.debtSlip ? `<button onclick="viewPopImage('debt-${child.key}', '${d.debtSlip}')" style="background:var(--orange); color:white; padding:5px; width:100%; border:none; margin-top:5px; border-radius:5px;">VIEW SETTLEMENT SLIP</button>
                    <img id="pop-img-debt-${child.key}" class="pop-preview" src="${d.debtSlip}">` : `<p style='color:red; font-size:10px;'>Waiting for driver to upload slip...</p>`;

                    div.innerHTML += `<div style="background:white; padding:10px; border-radius:8px; margin-bottom:10px; border-left:5px solid red;"><strong>${d.name} owes R${d.pendingDebt}</strong><br>Phone: ${d.phone}<br>${slipHtml}<button onclick="clearDriverDebt('${d.phone}')" style="background:var(--green); color:white; padding:5px; width:100%; margin-top:5px; border:none; border-radius:5px;">CONFIRM PAYMENT RECEIVED</button></div>`;
                }
            });
            if(count === 0) div.innerHTML = "No pending payments from drivers.";
        });
    }

    function clearDriverDebt(phone) {
        if(confirm("Confirm that you have received the cash from this driver?")) {
            database.ref('drivers/' + phone).update({ currentStatus: 'available', pendingDebt: null, debtSlip: null });
            showAppNotify("Debt Cleared", "Driver is now active and can receive orders again.", "var(--green)");
        }
    }

    function showAppNotify(header, msg, color = "var(--primary)", showAction = true) {
        document.getElementById('notifyHeader').innerText = header;
        document.getElementById('notifySub').innerText = msg;
        const notifyEl = document.getElementById('verifyNotify');
        const iconEl = document.getElementById('notifyIcon');
        
        document.getElementById('forgotPinInputArea').style.display = "none";
        document.getElementById('otpVerifyArea').style.display = "none";
        document.getElementById('pinOutput').style.display = "none";
        
        if (color === 'var(--green)') iconEl.innerHTML = '‚úÖ';
        else if (color === 'var(--orange)') iconEl.innerHTML = 'üöö';
        else iconEl.innerHTML = 'üîî';
        
        notifyEl.style.borderTop = `5px solid ${color}`;
        iconEl.style.backgroundColor = color;
        document.getElementById('notifyActionBtn').style.backgroundColor = color;
        document.getElementById('notifyActionBtn').style.display = showAction ? "block" : "none";
        
        notifyEl.style.display = "block";
        triggerAlert();
    }

    function forgotPin() {
        closeLoginModal();
        showAppNotify("FORGOT PIN", "Enter your phone number. Admin will send your qualification code via WhatsApp.", "var(--blue)", false);
        document.getElementById('forgotPinInputArea').style.display = "block";
    }

    async function requestQualificationCode() {
        recoveryUserPhone = document.getElementById('forgotPhoneInput').value;
        if(!recoveryUserPhone) return alert("Please enter a phone number.");
        
        const path = (currentRoleType === 'driver') ? 'drivers/' : 'users/';
        database.ref(path + recoveryUserPhone).once('value', async (snap) => {
            if(snap.exists()) {
                const userName = snap.val().name || "User";
                const code = Math.floor(100000 + Math.random() * 900000).toString();
                
                await database.ref('verificationRequests/' + recoveryUserPhone).set({ 
                    name: userName, 
                    phone: recoveryUserPhone, 
                    code: code, 
                    timestamp: Date.now(), 
                    autoSent: false 
                });
                
                document.getElementById('forgotPinInputArea').style.display = "none";
                document.getElementById('otpVerifyArea').style.display = "block";
                document.getElementById('notifySub').innerText = "Request sent to Admin. Please wait for a WhatsApp message with your code.";
            } else { 
                showAppNotify("Error", "Phone number not found.", "var(--primary)"); 
            }
        });
    }

    function fetchVerificationRequests() {
        const div = document.getElementById('admin-verify-requests');
        database.ref('verificationRequests').on('value', snap => {
            div.innerHTML = "";
            if(!snap.exists()) { div.innerHTML = "No active verification requests."; return; }
            snap.forEach(child => {
                const req = child.val();
                const phoneKey = child.key;
                let waPhone = req.phone.startsWith('0') ? '27' + req.phone.substring(1) : req.phone;
                
                div.innerHTML += `<div style="background:white; padding:10px; border-radius:10px; margin-bottom:10px; border: 1px solid #ddd;">
                    <strong>${req.name} (${req.phone})</strong><br>
                    Qualification Code: <span style="color:var(--blue); font-weight:bold; font-size:1.2rem;">${req.code}</span><br>
                    <button onclick="manualSendCode('${phoneKey}', '${waPhone}', '${req.name}', '${req.code}')" style="background:var(--green); color:white; border:none; padding:8px; margin-top:5px; border-radius:5px; width:100%; font-weight:bold;">SEND CODE VIA WHATSAPP</button>
                    <button onclick="clearVerifyRequest('${req.phone}')" style="background:#eee; color:#666; border:none; padding:5px; width:100%; margin-top:5px; border-radius:5px; font-size:11px;">Clear Request</button>
                </div>`;
            });
        });
    }

    function manualSendCode(key, phone, name, code) { 
        database.ref('verificationRequests/' + key).update({ autoSent: true }); 
        window.open(`https://wa.me/${phone}?text=Hi ${name}, your SA Pills qualification code is: ${code}`, '_blank'); 
    }

    function clearVerifyRequest(phone) { database.ref('verificationRequests/' + phone).remove(); }

    function verifyQualificationCode() {
        const enteredCode = document.getElementById('otpCodeInput').value;
        const path = (currentRoleType === 'driver') ? 'drivers/' : 'users/';
        
        database.ref('verificationRequests/' + recoveryUserPhone).once('value', (vSnap) => {
            if(vSnap.exists() && vSnap.val().code === enteredCode) {
                database.ref(path + recoveryUserPhone).once('value', (uSnap) => {
                    revealPin(uSnap.val().pin);
                    database.ref('verificationRequests/' + recoveryUserPhone).remove();
                });
            } else { 
                alert("Invalid code. Please wait for the code from Admin via WhatsApp."); 
            }
        });
    }

    function revealPin(pin) {
        document.getElementById('otpVerifyArea').style.display = "none";
        document.getElementById('pinOutput').style.display = "block";
        document.getElementById('pinOutput').innerHTML = `${pin}<span class="copy-tag">TAP TO COPY</span>`;
        document.getElementById('notifySub').innerText = "Verified! Your access PIN is displayed below. Tap to copy.";
        document.getElementById('notifyActionBtn').style.display = "block";
    }

    // --- END PRO INJECTED LOGIC ---

    function checkAutoLogin() {
        startAutoManager();
        if (sessionStorage.getItem('ageVerified') === 'true') {
            document.getElementById('age-gate').style.display = 'none';
            document.getElementById('role-selection').style.display = 'flex';
        }
        if(localStorage.getItem('custName')) document.getElementById('custName').value = localStorage.getItem('custName');
        if(localStorage.getItem('custPhone')) document.getElementById('custPhone').value = localStorage.getItem('custPhone');
        if(localStorage.getItem('custAddress')) document.getElementById('custAddress').value = localStorage.getItem('custAddress');
        
        const savedCart = localStorage.getItem('userCart');
        if(savedCart) { cart = JSON.parse(savedCart); updateTotal(); updateCartUI(); }
        
        const savedPhone = localStorage.getItem('driverLoggedInPhone');
        const savedRole = localStorage.getItem('userRole');
        const myOrderId = localStorage.getItem('myOrderID');
        const lastPage = localStorage.getItem('lastPageVisited'); // MEMORY FIX
        
        if(savedPhone && savedRole) {
            loggedInDriverPhone = savedPhone;
            currentRoleType = savedRole;
            document.getElementById('age-gate').style.display = 'none';
            document.getElementById('role-selection').style.display = 'none';
            
            // REFRESH FIX: If customer was on tracking, stay there
            if(currentRoleType === 'driver') showPage('driver');
            else if(currentRoleType === 'admin') showPage('admin');
            else if(lastPage === 'tracking' && myOrderId) showPage('tracking');
            else showPage('shop');
        } else if (myOrderId && lastPage === 'tracking') {
             showPage('tracking'); // Handle guest checkout refresh
        }
        
        if(myOrderId){
            document.getElementById('tab-track-btn').style.display = 'block';
            database.ref('orders/' + myOrderId + '/arrived').on('value', snap => {
                if(snap.val() === true){ showAppNotify("DRIVER ARRIVED!", "Your delivery driver is currently outside your location.", "var(--orange)"); }
            });
        }
    }

    function startAutoManager() {
        database.ref('orders').on('value', (snapshot) => {
            snapshot.forEach(child => {
                const order = child.val();
                const orderId = child.key;
                
                // NEW: AUTO REASSIGN IF DRIVER DOES NOT ACCEPT WITHIN 10 MINS
                if(order.status === 'dispatched' && !order.driverReceived) {
                    const now = Date.now();
                    const assignedAt = order.assignedTimestamp || 0;
                    const diff = now - assignedAt;
                    if(diff > 600000) { // 10 minutes (600,000 ms)
                        reassignOrderBackToAdmin(orderId, order.dPhone);
                    }
                }
                
                if(order.status === 'pending') {
                    setTimeout(() => {
                        database.ref('orders/' + orderId).once('value', (freshSnap) => {
                            const freshData = freshSnap.val();
                            if(freshData && freshData.status === 'pending') { autoDispatchOrder(orderId, freshData); }
                        });
                    }, 5000); 
                }
            });
        });
    }

    function autoDispatchOrder(orderId, orderData) {
        database.ref('drivers').once('value', (snap) => {
            snap.forEach(driverSnap => {
                const driver = driverSnap.val();
                if (driver.village === orderData.area && driver.currentStatus === 'available') {
                    dispatchToDriver(orderId, driver, 'System Auto-Dispatch');
                    return true;
                }
            });
        });
    }

    function dispatchToDriver(orderId, driver, managerType) {
        database.ref('orders/' + orderId).update({ 
            status: 'dispatched', 
            dName: driver.name, 
            dPhone: driver.phone, 
            driverReceived: false, 
            arrived: false, 
            managedBy: managerType,
            assignedTimestamp: Date.now() // Track when assigned
        });
        database.ref('drivers/' + driver.phone).update({ currentStatus: 'delivering' });
    }

    function reassignOrderBackToAdmin(orderId, driverPhone) {
        database.ref('orders/' + orderId).update({
            status: 'pending',
            dName: null,
            dPhone: null,
            driverReceived: false,
            assignedTimestamp: null
        });
        if(driverPhone) {
            database.ref('drivers/' + driverPhone).update({ currentStatus: 'available' });
        }
    }

    function verifyAge() { 
        sessionStorage.setItem('ageVerified', 'true');
        document.getElementById('age-gate').style.display = 'none'; 
        document.getElementById('role-selection').style.display = 'flex';
    }

    function selectRole(role) {
        currentRoleType = role;
        document.getElementById('role-selection').style.display = 'none';
        if(role === 'customer') {
            document.getElementById('loginTitle').innerText = "Customer Login";
            document.getElementById('customerRegArea').style.display = "block";
            openLoginModal();
        } else if(role === 'driver') {
            document.getElementById('loginTitle').innerText = "Driver Portal Login";
            document.getElementById('customerRegArea').style.display = "block";
            openLoginModal();
        } else if(role === 'admin') {
            document.getElementById('loginTitle').innerText = "Admin Console Access";
            document.getElementById('customerRegArea').style.display = "none";
            openLoginModal();
        }
    }

    function switchRoleManual() {
        const pages = ['shop-page', 'checkout-page', 'admin-page', 'tracking-page', 'driver-page', 'footer-controls'];
        pages.forEach(p => document.getElementById(p).style.display = 'none');
        document.getElementById('role-selection').style.display = 'flex';
    }

    function resetRoleSelection() {
        switchRoleManual();
        localStorage.removeItem('driverLoggedInPhone');
        localStorage.removeItem('userRole');
        localStorage.removeItem('myOrderID');
        localStorage.removeItem('lastPageVisited');
        clearInterval(orderTimerInterval);
    }

    function exitSite() { window.location.href = "https://google.com"; }
    function driverLogout() { localStorage.removeItem('driverLoggedInPhone'); localStorage.removeItem('userRole'); localStorage.removeItem('lastPageVisited'); loggedInDriverPhone = null; switchRoleManual(); }

    function showPage(page) {
        localStorage.setItem('lastPageVisited', page); // MEMORY FIX
        document.getElementById('shop-page').style.display = page === 'shop' ? 'block' : 'none';
        document.getElementById('checkout-page').style.display = page === 'checkout' ? 'block' : 'none';
        document.getElementById('admin-page').style.display = page === 'admin' ? 'block' : 'none';
        document.getElementById('tracking-page').style.display = page === 'tracking' ? 'block' : 'none';
        document.getElementById('driver-page').style.display = page === 'driver' ? 'block' : 'none';
        document.getElementById('footer-controls').style.display = (page === 'shop' || page === 'checkout') ? 'block' : 'none';
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active-tab'));
        if(page === 'shop') document.getElementById('tab-shop-btn').classList.add('active-tab');
        if(page === 'checkout') { document.getElementById('tab-check-btn').classList.add('active-tab'); updateCartUI(); }
        if(page === 'tracking') { document.getElementById('tab-track-btn').classList.add('active-tab'); updateTrackingUI(); }
        if(page === 'admin') { fetchDrivers(); fetchLiveOrders(); fetchPendingDrivers(); fetchDebtRequests(); fetchVerificationRequests(); fetchAdminPendingPayments(); }
        if(page === 'driver') { loadDriverPortal(); }
    }

    function addToCart(n, p) { cart.push({name: n, price: p}); updateTotal(); localStorage.setItem('userCart', JSON.stringify(cart)); document.getElementById('customModal').style.display = "block"; }
    function removeFromCart(index) { cart.splice(index, 1); updateTotal(); updateCartUI(); localStorage.setItem('userCart', JSON.stringify(cart)); }
    function updateTotal() { const total = cart.reduce((s, i) => s + i.price, 0); document.getElementById('cart-total').innerText = `Total Order: R ${total.toFixed(2)}`; }
    
    function updateCartUI() {
        const list = document.getElementById('cart-list');
        if(cart.length === 0) { list.innerHTML = "Your selection is currently empty."; return; }
        let html = "";
        cart.forEach((item, index) => { html += `<div class="cart-row"><span>${item.name} (R${item.price})</span><button class="cart-del" onclick="removeFromCart(${index})">REMOVE</button></div>`; });
        list.innerHTML = html;
    }

    function closeModal() { document.getElementById('customModal').style.display = "none"; }
    function openLoginModal() { document.getElementById('loginModal').style.display = "block"; document.getElementById('verifyNotify').style.display = "none"; }
    function closeLoginModal() { 
        document.getElementById('loginModal').style.display = "none"; 
        const isUserOnPage = document.getElementById('shop-page').style.display === 'block' || document.getElementById('admin-page').style.display === 'block' || document.getElementById('driver-page').style.display === 'block';
        if(!isUserOnPage) document.getElementById('role-selection').style.display = 'flex';
    }
    
    function openRegisterModal() { 
        document.getElementById('loginModal').style.display = "none"; 
        document.getElementById('registerModal').style.display = "block"; 
        if(currentRoleType === 'customer') {
            document.getElementById('regTitle').innerText = "Customer Registration";
            document.getElementById('regInfo').innerText = "Create a PIN to track your future orders easily.";
            document.getElementById('areaRegGroup').style.display = 'none';
        } else {
            document.getElementById('regTitle').innerText = "Driver Registration";
            document.getElementById('regInfo').innerText = "After registering, Admin must approve your account.";
            document.getElementById('areaRegGroup').style.display = 'block';
        }
    }
    function closeRegisterModal() { document.getElementById('registerModal').style.display = "none"; document.getElementById('role-selection').style.display = 'flex'; }
    function closeVerifyNotify() { document.getElementById('verifyNotify').style.display = "none"; if (alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; } notificationSound.pause(); }
    function copyPin() { const pin = document.getElementById('pinOutput').innerText.replace('TAP TO COPY', '').trim(); navigator.clipboard.writeText(pin); showAppNotify("Information Copied", "PIN has been successfully copied.", "var(--green)"); }

    function submitRegistration() {
        const name = document.getElementById('regDriverName').value;
        const phone = document.getElementById('regDriverPhone').value;
        const pin = document.getElementById('regDriverPin').value;
        const area = document.getElementById('regVillage').value;
        
        if(!name || !phone || !pin) return showAppNotify("Missing Information", "Please ensure name, phone and PIN are filled.", "var(--primary)");
        
        if(currentRoleType === 'driver') {
            if(!area) return showAppNotify("Missing Area", "Please select your delivery area.", "var(--primary)");
            database.ref('pendingDrivers/' + phone).set({ name, phone, pin, village: area, status: 'pending' }).then(() => {
                showAppNotify("Application Submitted", "Your driver registration has been sent for review.", "var(--green)");
                closeRegisterModal();
            });
        } else {
            database.ref('users/' + phone).set({ name, phone, pin, role: 'customer' }).then(() => {
                showAppNotify("Registration Complete", "You can now log in with your phone and PIN.", "var(--green)");
                closeRegisterModal();
            });
        }
    }

    function fetchPendingDrivers() {
        const div = document.getElementById('driver-approval-list');
        database.ref('pendingDrivers').on('value', snap => {
            div.innerHTML = "";
            if(!snap.exists()) { div.innerHTML = "No pending approval requests."; return; }
            snap.forEach(child => {
                const d = child.val();
                div.innerHTML += `<div class="approval-card"><strong>${d.name}</strong> (${d.phone})<br>Area: ${d.village}<br><button onclick="approveDriver('${d.phone}')" style="background:var(--green); color:white; padding:8px; width:48%;">Accept</button><button onclick="declineDriver('${d.phone}')" style="background:var(--primary); color:white; padding:8px; width:48%;">Decline</button></div>`;
            });
        });
    }

    function approveDriver(phone) {
        database.ref('pendingDrivers/' + phone).once('value', snap => {
            const data = snap.val();
            database.ref('drivers/' + phone).set({ name: data.name, phone: data.phone, pin: data.pin, village: data.village, currentStatus: 'available' }).then(() => {
                database.ref('pendingDrivers/' + phone).remove();
                showAppNotify("Driver Approved", `Account for ${data.name} is now active.`, "var(--green)");
            });
        });
    }

    function declineDriver(phone) { if(confirm("Permanently decline this driver application?")) database.ref('pendingDrivers/' + phone).remove(); }

    function checkAdminLogin() {
        const phone = document.getElementById('loginPhoneInput').value;
        const pin = document.getElementById('adminPinInput').value;
        if(currentRoleType === 'admin') {
            if((pin === "0774" || pin === "0000")) { 
                localStorage.setItem('driverLoggedInPhone', 'admin');
                localStorage.setItem('userRole', 'admin');
                document.getElementById('loginModal').style.display = "none";
                showPage('admin'); 
            } else { showAppNotify("Access Denied", "Incorrect PIN.", "var(--primary)"); }
            return;
        }
        const dbPath = (currentRoleType === 'driver') ? 'drivers/' : 'users/';
        database.ref(dbPath + phone).once('value', (snap) => {
            if(snap.exists() && snap.val().pin === pin) {
                loggedInDriverPhone = phone;
                localStorage.setItem('driverLoggedInPhone', phone);
                localStorage.setItem('userRole', currentRoleType);
                if(snap.val().name) localStorage.setItem('custName', snap.val().name);
                document.getElementById('loginModal').style.display = "none";
                if(currentRoleType === 'driver') showPage('driver');
                else { checkAutoLogin(); showPage('shop'); }
            } else { showAppNotify("Authentication Failed", "Incorrect details entered.", "var(--primary)"); }
        });
    }

    function updateVillages(targetId) {
        let provinceId = (targetId === 'adminVillage') ? 'adminProvince' : (targetId === 'regVillage' ? 'regProvince' : 'province');
        const province = document.getElementById(provinceId).value;
        const select = document.getElementById(targetId);
        select.innerHTML = '<option value="">-- Area --</option>';
        let areas = [];
        if (province === "Gauteng") { areas = ["Alexandra", "Diepsloot", "Ennerdale", "Johannesburg", "Lenasia (Lenz)", "Midrand", "Modderfontein", "Orange Farm", "Randburg", "Roodepoort", "Sandton", "Soweto", "Alberton", "Bedfordview", "Benoni", "Boksburg", "Brakpan", "Clayville", "Daveyton", "Devon", "Duduza", "Dunnottar", "Edenvale", "Germiston", "Isando", "Katlehong", "Kempton Park", "KwaThema", "Nigel", "Reiger Park", "Springs", "Tembisa", "Thokoza", "Tsakane", "Vosloorus", "Wattville", "Atteridgeville", "Bronberg", "Bronkhorstspruit", "Centurion", "Cullinan", "Ekangala", "Ga-Rankuwa", "Hammanskraal", "Irene", "Mabopane", "Mamelodi", "Pretoria", "Rayton", "Refilwe", "Soshanguve", "Winterveld", "Zithobeni"];
        } else if (province === "North West") { areas = ["Bloemhof", "Brits", "Christiana", "Coligny", "Delareyville", "Ganyesa", "Groot Marico", "Hartbeespoort", "Jan Kempdorp", "Klerksdorp", "Koster", "Lichtenburg", "Mahikeng", "Mogwase", "Mooinooi", "Orkney", "Ottosdal", "Potchefstroom", "Reivilo", "Rustenburg", "Sannieshof", "Schweizer-Reneke", "Stella", "Stilfontein", "Swartruggens", "Taung", "Ventersdorp", "Vryburg", "Wolmaransstad", "Zeerust"];
        } else if (province === "Free State") { areas = ["Bloemfontein", "Heidedal", "Langenhovenpark", "Welkom", "Kroonstad", "Bethlehem", "Phuthaditjhaba", "Sasolburg", "Parys", "Winburg", "Jagersfontein", "Virginia"];
        } else if (province === "Western Cape") { areas = ["Bellville", "Durbanville", "Parow", "Goodwood", "Brackenfell", "Kraaifontein", "Kuils River", "Rondebosch", "Claremont", "Newlands", "Constantia", "Wynberg", "Plumstead", "Kenilworth", "Simon‚Äôs Town", "Fish Hoek", "Muizenberg", "Noordhoek", "Kommetjie", "Scarborough", "Somerset West", "Strand", "Gordon‚Äôs Bay", "Camps Bay", "Hout Bay", "Sea Point", "Green Point", "Llandudno", "Milnerton", "Table View", "Bloubergstrand", "Melkbosstrand", "Atlantis", "Athlone", "Mitchells Plain", "Khayelitsha", "Gugulethu", "Langa", "Nyanga", "Delft"];
        } else if (province === "KZN") { areas = ["Durban", "Amanzimtoti", "Chatsworth", "Hillcrest", "Kloof", "Pinetown", "Phoenix", "Umhlanga", "Umlazi", "Verulam", "Westville", "Tongaat", "Kingsburgh", "Port Shepstone", "Margate", "Scottburgh", "Harding", "Hibberdene", "Pennington", "Port Edward", "Southbroom", "Umzinto", "Shelly Beach", "KwaDukuza (Stanger)", "Ballito", "Mandeni", "Salt Rock", "Maphumulo", "Shakaskraal", "Pietermaritzburg", "Howick", "Hilton", "Richmond", "Mooi River", "Wartburg", "Dalton", "Ixopo", "Kokstad", "Underberg", "Himeville", "Bulwer", "Umzimkhulu", "Newcastle", "Dannhauser", "Charlestown", "Madadeni", "Ladysmith", "Estcourt", "Bergville", "Colenso", "Winterton", "Dundee", "Greytown", "Nquthu", "Pomeroy", "Glencoe", "Ulundi", "Vryheid", "Nongoma", "Pongola", "Paulpietersburg", "Richards Bay", "Empangeni", "Eshowe", "Melmoth", "Mtunzini", "Mkuze", "St Lucia", "Hluhluwe", "Mtubatuba", "Jozini"]; }
        areas.sort().forEach(a => { let o = document.createElement('option'); o.value = a; o.innerText = a; select.appendChild(o); });
    }

    function saveDriver() {
        const name = document.getElementById('driverName').value;
        const phone = document.getElementById('driverPhone').value;
        const area = document.getElementById('adminVillage').value;
        if(name && phone && area) {
            database.ref('drivers/' + phone).once('value', (snap) => {
                if(snap.exists()) showAppNotify("Duplicate Driver", "Phone number already registered.", "var(--primary)");
                else {
                    database.ref('drivers/' + phone).update({ name, phone, village: area, pin: "0000", currentStatus: 'available' });
                    document.getElementById('driverName').value = ""; document.getElementById('driverPhone').value = "";
                    showAppNotify("Driver Registered", "Manual addition successful.", "var(--green)");
                }
            });
        }
    }

    function fetchDrivers() {
        database.ref('drivers').on('value', (snapshot) => {
            allDrivers = []; const listDiv = document.getElementById('driver-list');
            listDiv.innerHTML = "<h4>Registered Drivers</h4>";
            snapshot.forEach(child => {
                const d = child.val(); allDrivers.push(d);
                let statusColor = d.currentStatus === 'delivering' ? "var(--green)" : (d.currentStatus === 'unpaid_debt' ? "var(--primary)" : "var(--blue)");
                listDiv.innerHTML += `<div class='driver-card' style='border-left: 8px solid ${statusColor};'><strong>${d.name}</strong> (${d.phone})<br><small>Area: ${d.village}</small><br><span class="status-badge" style="background:${statusColor};">${d.currentStatus}</span><button onclick="deleteDriver('${d.phone}')" class='del-btn' style="margin-left:10px;">Remove</button></div>`;
            });
        });
    }

    function deleteDriver(phone) { if(confirm("Permanently remove this driver?")) database.ref('drivers/' + phone).remove(); }

    function fetchLiveOrders() {
        const orderDiv = document.getElementById('live-orders-list');
        const activeDiv = document.getElementById('active-deliveries-list');
        database.ref('orders').on('value', (snapshot) => {
            orderDiv.innerHTML = ""; activeDiv.innerHTML = "";
            let hasNew = false; let hasActive = false;
            if(!snapshot.exists()) return;
            snapshot.forEach((child) => {
                const o = child.val(); const orderId = child.key;
                const shortId = orderId.substring(orderId.length - 6);
                
                // ACTIVE DELIVERIES DASHBOARD FIX
                if(o.status === 'dispatched' || o.status === 'delivered' || o.status === 'failed') {
                    hasActive = true;
                    let ack = o.driverReceived ? "<span style='color:green; font-weight:bold;'>‚úÖ DRIVER ACCEPTED</span>" : "<span style='color:orange;'>‚è≥ Waiting...</span>";
                    let finalStatus = o.status === 'delivered' ? "‚úÖ DELIVERED" : (o.status === 'failed' ? "‚ùå FAILED" : "üöö EN ROUTE");
                    
                    // REASSIGN DRIVER SELECT (If driver hasn't accepted yet)
                    let reassignHtml = "";
                    if(!o.driverReceived && o.status === 'dispatched') {
                        let reOptions = `<option value="">-- Change Driver --</option>`;
                        allDrivers.forEach(dr => { if(dr.currentStatus === 'available') reOptions += `<option value="${dr.phone}">${dr.name}</option>`; });
                        reassignHtml = `<div class="assign-area"><select id="re-${orderId}">${reOptions}</select><button onclick="reassignDriver('${orderId}')" style="background:var(--orange); font-size:10px; padding:5px; margin-top:5px;">Update Driver</button></div>`;
                    }

                    activeDiv.innerHTML += `<div class="delivery-card"><strong>üì¶ PILLS-${shortId}</strong><br><strong>Status: ${finalStatus}</strong><br><strong>üöö Driver: ${o.dName}</strong><br>${ack}${reassignHtml}<hr><button onclick="deleteOrder('${orderId}')" class="del-btn">Remove Record</button></div>`;
                } else if(o.status === 'pending') {
                    hasNew = true;
                    let suggestedDriver = allDrivers.find(d => d.village === o.area && d.currentStatus === 'available');
                    let driverOptions = `<option value="">-- Select Driver --</option>`;
                    allDrivers.forEach(dr => { if(dr.currentStatus === 'available') { let isSuggested = (suggestedDriver && dr.phone === suggestedDriver.phone) ? ' (SUGGESTED)' : ''; driverOptions += `<option value="${dr.phone}">${dr.name} (${dr.village})${isSuggested}</option>`; } });
                    let card = document.createElement('div');
                    card.className = "order-card";
                    card.innerHTML = `<strong>üìç Area: ${o.area}</strong><br><strong>üë§ ${o.customer}</strong><br><strong>üí∞ ${o.total}</strong><div class="assign-area"><select id="select-${orderId}">${driverOptions}</select><button onclick="dispatchSpecificOrder('${orderId}')" style="background:var(--blue); color:white; width:100%; padding:12px; margin-top:5px; font-weight:bold;">Assign Driver</button></div>`;
                    orderDiv.appendChild(card);
                }
            });
            if(!hasNew) orderDiv.innerHTML = "No new pending orders.";
            if(!hasActive) activeDiv.innerHTML = "No active delivery processes.";
        });
    }

    // NEW: ADMIN PAYMENT LIST (UPDATED WITH POP VIEWER & CANCEL SYSTEM)
    function fetchAdminPendingPayments() {
        const div = document.getElementById('admin-pending-payments');
        database.ref('orders').orderByChild('status').equalTo('awaiting_payment').on('value', snap => {
            div.innerHTML = "";
            let count = 0;
            snap.forEach(child => {
                count++;
                const o = child.val();
                let popHtml = o.popImage ? `<button onclick="viewPopImage('${child.key}', '${o.popImage}')" style="background:var(--orange); color:white; border:none; padding:8px; margin-top:5px; width:100%; border-radius:5px; font-weight:bold;">VIEW POP SCREENSHOT</button>
                <img id="pop-img-${child.key}" class="pop-preview" src="${o.popImage}">` : `<p style='color:red; font-size:11px;'>No screenshot uploaded yet.</p>`;
                
                div.innerHTML += `<div style="background:white; padding:10px; border-radius:10px; margin-bottom:10px; border-left:5px solid #2196f3;">
                    <strong>Customer: ${o.customer}</strong><br>
                    Amount: ${o.total}<br>
                    ${popHtml}
                    <button onclick="adminConfirmPayment('${child.key}')" style="background:var(--green); color:white; border:none; padding:8px; margin-top:10px; width:100%; border-radius:5px; font-weight:bold;">CONFIRM PAYMENT RECEIVED</button>
                    <button onclick="adminCancelOrderPrompt('${child.key}')" style="background:#eee; color:#c00; border:1px solid #fcc; padding:8px; width:100%; margin-top:5px; border-radius:5px; font-weight:bold;">REPLY / CANCEL ORDER</button>
                </div>`;
            });
            if(count === 0) div.innerHTML = "No pending payments.";
        });
    }

    function viewPopImage(id, src) {
        let img = document.getElementById('pop-img-' + id);
        img.style.display = img.style.display === 'block' ? 'none' : 'block';
    }

    // NEW: CUSTOMER POP UPLOADER
    function handlePopUpload(input) {
        if (input.files && input.files[0]) {
            const orderId = localStorage.getItem('myOrderID');
            const reader = new FileReader();
            reader.onload = function(e) {
                database.ref('orders/' + orderId).update({ popImage: e.target.result, status: 'awaiting_payment' });
                document.getElementById('pop-success-msg').style.display = 'block';
                showAppNotify("Upload Successful", "Proof of payment has been sent to Admin dashboard.", "var(--green)");
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // NEW: DRIVER DEBT SLIP UPLOADER
    function handleDriverPopUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                database.ref('drivers/' + loggedInDriverPhone).update({ debtSlip: e.target.result });
                document.getElementById('driver-pop-success').style.display = 'block';
                showAppNotify("Slip Uploaded", "Admin has been notified. They will clear you shortly.", "var(--green)");
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function adminConfirmPayment(orderId) {
        if(confirm("Have you verified the money in the bank?")) {
            database.ref('orders/' + orderId).update({ status: 'pending', cancelReason: null });
            showAppNotify("Payment Confirmed", "Order is now in 'New Orders' list.", "var(--green)");
        }
    }

    function adminCancelOrderPrompt(id) {
        const reason = prompt("Enter the reason for cancellation or your reply to the customer:");
        if(reason !== null && reason.trim() !== "") {
            database.ref('orders/' + id).update({ status: 'cancelled', cancelReason: reason.trim() }).then(() => {
                showAppNotify("Order Updated", "The customer has been notified.", "var(--primary)");
            });
        }
    }

    function switchOrderToCOD() {
        const orderId = localStorage.getItem('myOrderID');
        if(!orderId) return;
        if(confirm("Change this order to Cash on Delivery? Our driver will collect the balance at your door.")) {
            database.ref('orders/' + orderId).update({ status: 'pending', payment: 'Cash on Delivery', cancelReason: null }).then(() => {
                showAppNotify("Payment Method Changed", "Order is now being processed as Cash on Delivery.", "var(--green)");
            });
        }
    }

    // FIX FOR NON-ACCEPTING DRIVERS & INCORRECT DRIVER NAME
    function reassignDriver(orderId) {
        const newDriverPhone = document.getElementById('re-' + orderId).value;
        if(!newDriverPhone) return alert("Select a new driver.");
        
        database.ref('orders/' + orderId).once('value', (snap) => {
            const oldDriverPhone = snap.val().dPhone;
            const newDriver = allDrivers.find(d => d.phone === newDriverPhone);
            
            // 1. Release old driver
            if(oldDriverPhone) database.ref('drivers/' + oldDriverPhone).update({currentStatus: 'available'});
            
            // 2. Assign new driver (Sync Name and Phone Fix)
            dispatchToDriver(orderId, newDriver, 'Admin Reassignment');
            showAppNotify("Driver Changed", `Order reassigned to ${newDriver.name}.`, "var(--green)");
        });
    }

    function deleteOrder(id) {
        if(confirm("Permanently delete this order?")) {
            database.ref('orders/' + id).once('value', (snap) => {
                const data = snap.val();
                if(data.dPhone) { database.ref('drivers/' + data.dPhone).update({currentStatus: 'available'}); }
                database.ref('orders/' + id).remove();
            });
        }
    }

    function dispatchSpecificOrder(orderId) {
        const driverPhone = document.getElementById('select-' + orderId).value;
        if(!driverPhone) return;
        const driver = allDrivers.find(d => d.phone === driverPhone);
        dispatchToDriver(orderId, driver, 'Admin Manual Dispatch');
        showAppNotify("Order Dispatched", `Assigned to ${driver.name}.`, "var(--green)");
    }

    function loadDriverPortal() {
        if(!loggedInDriverPhone) return;
        database.ref('drivers/' + loggedInDriverPhone).on('value', snap => {
            if(!snap.exists()) return;
            const driver = snap.val();
            document.getElementById('portal-driver-name').innerText = driver.name;
            if(driver.currentStatus === 'unpaid_debt') {
                document.getElementById('driver-debt-screen').style.display = 'block';
                document.getElementById('pending-debt-display').innerText = `R ${driver.pendingDebt}`;
                document.getElementById('assigned-task-card').style.display = 'none';
                document.getElementById('no-task-msg').style.display = 'none';
                return;
            } else { document.getElementById('driver-debt-screen').style.display = 'none'; }
            
            // REAL-TIME TASK WATCHER
            database.ref('orders').orderByChild('dPhone').equalTo(loggedInDriverPhone).on('value', snapOrders => {
                const taskCard = document.getElementById('assigned-task-card');
                const taskDetails = document.getElementById('task-details');
                const ackBtn = document.getElementById('driver-acknowledge-btn');
                const rejectBtn = document.getElementById('driver-reject-btn');
                const arriveBtn = document.getElementById('driver-arrive-btn');
                const finalActions = document.getElementById('delivery-final-actions');
                let foundTask = false;
                taskDetails.innerHTML = "";
                
                if(snapOrders.exists()) {
                    snapOrders.forEach(oSnap => {
                        const o = oSnap.val();
                        if(o.status === 'dispatched') {
                            foundTask = true; activeTaskID = oSnap.key;
                            taskDetails.innerHTML = `<p><strong>ID: PILLS-${activeTaskID.substring(activeTaskID.length - 6)}</strong></p><p><strong>Cust:</strong> ${o.customer}</p><p><strong>Addr:</strong> ${o.address}</p><p><strong>Items:</strong> ${o.items}</p><p><strong>Price:</strong> ${o.total}</p>`;
                            
                            // Accept/Reject visibility
                            ackBtn.style.display = o.driverReceived ? "none" : "block";
                            rejectBtn.style.display = o.driverReceived ? "none" : "block";
                            
                            arriveBtn.style.display = (o.driverReceived && !o.arrived) ? "block" : "none";
                            finalActions.style.display = (o.driverReceived && o.arrived) ? "grid" : "none";
                            
                            ackBtn.onclick = () => { database.ref('orders/' + oSnap.key).update({ driverReceived: true }); };
                            
                            // Manual Reject Function
                            rejectBtn.onclick = () => {
                                if(confirm("Are you sure you want to return this order to Admin?")) {
                                    reassignOrderBackToAdmin(oSnap.key, loggedInDriverPhone);
                                    showAppNotify("Order Returned", "Task sent back to Admin dashboard.", "var(--orange)");
                                }
                            };

                            // MAP LOCATION FIX (Standard search query is more reliable for Protea North)
                            document.getElementById('map-link-btn').onclick = () => { 
                                const fullLocation = `${o.address}, ${o.area}, South Africa`;
                                window.open(`maps.google.com${encodeURIComponent(fullLocation)}`, '_blank'); 
                            };
                            
                            document.getElementById('cust-whatsapp-btn').onclick = () => { let cp = o.phone; if(cp.startsWith('0')) cp = '27' + cp.substring(1); window.open(`https://wa.me/${cp}?text=Hi, I am your driver.`, '_blank'); };
                        }
                    });
                }
                taskCard.style.display = foundTask ? 'block' : 'none';
                document.getElementById('no-task-msg').style.display = foundTask ? 'none' : 'block';
            });
        });
    }

    function notifyArrival() { if(!activeTaskID) return; database.ref('orders/' + activeTaskID).update({ arrived: true }).then(() => { showAppNotify("Arrival Confirmed", "Customer notified.", "var(--orange)"); }); }
    function updateDeliveryStatus(status) { if(!activeTaskID) return; database.ref('orders/' + activeTaskID).update({ status: status }); database.ref('drivers/' + loggedInDriverPhone).update({ currentStatus: 'available' }); showAppNotify("Action Completed", "Order updated.", status === 'delivered' ? "var(--green)" : "var(--primary)"); }

    function sendOrder() {
        const o = collectData();
        if(!o.customer || !o.area || cart.length === 0) return showAppNotify("Action Required", "Fill details.", "var(--primary)");
        
        // PAYMENT RULE: If Capitec, set to awaiting_payment
        const finalStatus = (o.payment === 'Capitec Bank') ? 'awaiting_payment' : 'pending';
        
        database.ref('users/' + o.phone).update({ name: o.customer, phone: o.phone, pin: "0000" });
        const newRef = database.ref('orders').push();
        newRef.set({...o, status: finalStatus, timestamp: Date.now()});
        const fullId = "PILLS-" + newRef.key.substring(newRef.key.length - 6);
        localStorage.setItem('myOrderID', newRef.key);
        
        const waMsg = (finalStatus === 'awaiting_payment') ? `New Order (Capitec): ${fullId}%0AItems: ${o.items}%0APrice: ${o.total}%0AI am sending the POP now.` : `New Order: ${fullId}%0AItems: ${o.items}%0APrice: ${o.total}`;
        
        window.open(`https://wa.me/27632010938?text=${waMsg}`, '_blank');
        showPage('tracking'); cart = []; updateTotal(); localStorage.removeItem('userCart');
    }

    function orderViaApp() {
        const o = collectData();
        if(!o.customer || !o.area || cart.length === 0) return showAppNotify("Action Required", "Fill details.", "var(--primary)");
        
        const finalStatus = (o.payment === 'Capitec Bank') ? 'awaiting_payment' : 'pending';
        
        database.ref('users/' + o.phone).update({ name: o.customer, phone: o.phone, pin: "0000" });
        const newRef = database.ref('orders').push();
        newRef.set({...o, status: finalStatus, timestamp: Date.now()});
        localStorage.setItem('myOrderID', newRef.key);
        showPage('tracking'); cart = []; updateTotal(); localStorage.removeItem('userCart');
        
        if(finalStatus === 'awaiting_payment') {
            showAppNotify("Payment Required", "Please upload Proof of Payment to system.", "var(--orange)");
        } else {
            showAppNotify("Order Received", "Tracking order...", "var(--green)");
        }
    }

    function collectData() { return { customer: document.getElementById('custName').value, phone: document.getElementById('custPhone').value, address: document.getElementById('custAddress').value, area: document.getElementById('village').value, items: cart.map(i => i.name).join(", "), total: document.getElementById('cart-total').innerText, payment: document.getElementById('payMethod').value }; }

    function updateTrackingUI() {
        const orderId = localStorage.getItem('myOrderID');
        if(!orderId) return;
        database.ref('orders/' + orderId).on('value', (snapshot) => {
            if(snapshot.exists()) {
                const d = snapshot.val();
                document.getElementById('tracking-order-number').innerText = `Order ID: PILLS-${orderId.substring(orderId.length - 6)}`;
                document.getElementById('order-items-summary').innerHTML = `<strong>Items:</strong> ${d.items}<br><strong>Total:</strong> ${d.total}`;
                
                // HANDLE CANCELLED STATUS
                if(d.status === 'cancelled') {
                    document.getElementById('tracking-cancelled-notice').style.display = 'block';
                    document.getElementById('cancel-reason-display').innerText = `${d.cancelReason}`;
                    document.getElementById('tracking-payment-notice').style.display = 'none';
                    document.getElementById('tracking-active-ui').style.display = 'none';
                    document.getElementById('orderTimer').style.display = 'none';
                    return;
                } else {
                    document.getElementById('tracking-cancelled-notice').style.display = 'none';
                    document.getElementById('tracking-active-ui').style.display = 'block';
                }

                // Show payment notice for Capitec
                document.getElementById('tracking-payment-notice').style.display = (d.status === 'awaiting_payment') ? 'block' : 'none';

                if(d.status === 'awaiting_payment') {
                    document.getElementById('progress-line').style.width = "10%"; 
                    document.getElementById('status-text').innerHTML = "Status: Awaiting Payment Confirmation..."; 
                }
                else if(d.status === 'pending') { 
                    document.getElementById('progress-line').style.width = "30%"; 
                    document.getElementById('status-text').innerHTML = "Status: Waiting for Dispatch..."; 
                    startCountdown(5, "DISPATCHING", true); 
                }
                else if(d.status === 'dispatched') { 
                    document.getElementById('progress-line').style.width = "90%"; 
                    document.getElementById('status-text').innerHTML = "Status: Driver En Route"; 
                    document.getElementById('driver-info').style.display = 'block'; 
                    document.getElementById('assigned-driver-name').innerText = d.dName; 
                    document.getElementById('assigned-driver-phone-display').innerText = d.dPhone;
                    
                    if(d.driverReceived) {
                        document.getElementById('driver-received-msg').style.display = 'block';
                        startCountdown(60, "EN ROUTE"); 
                    } else {
                        startCountdown(5, "HAND-OVER", true); 
                    }
                } else {
                    document.getElementById('orderTimer').style.display = 'none';
                    clearInterval(orderTimerInterval);
                }
            }
        });
    }

    function finishOrder() {
        const id = localStorage.getItem('myOrderID');
        if(!id) return;
        database.ref('orders/' + id).once('value', snap => {
            const order = snap.val();
            if(order) {
                database.ref('orders/' + id).update({ status: 'delivered' });
                if(order.payment === 'Cash on Delivery' && order.dPhone) {
                    let cleanTotal = order.total.replace(/[^0-9.]/g, '');
                    let debt = (parseFloat(cleanTotal) / 2).toFixed(2);
                    database.ref('drivers/' + order.dPhone).update({ currentStatus: 'unpaid_debt', pendingDebt: debt });
                } else if(order.dPhone) { database.ref('drivers/' + order.dPhone).update({ currentStatus: 'available' }); }
                localStorage.removeItem('myOrderID');
                localStorage.removeItem('lastPageVisited'); // CLEAR MEMORY
                document.getElementById('tracking-content').style.display = 'none';
                document.getElementById('order-complete-view').style.display = 'block';
                showAppNotify("Order Finalized", "Thank you for using our service!", "var(--green)");
            }
        });
    }

    function returnToMenu() { 
        document.getElementById('tracking-content').style.display = 'block'; 
        document.getElementById('order-complete-view').style.display = 'none'; 
        localStorage.removeItem('myOrderID');
        showPage('shop'); 
    }
</script>
</body>
</html>
