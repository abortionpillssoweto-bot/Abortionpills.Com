<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SA Abortion Pills Delivery</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="SA Pills">
    <meta name="theme-color" content="#e41e26">
    
    <link rel="apple-touch-icon" href="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg">
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22SA%20Abortion%20Pills%20Delivery%22,%22short_name%22:%22SA%20Pills%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#ffffff%22,%22theme_color%22:%22#e41e26%22,%22icons%22:[{%22src%22:%22https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg%22,%22sizes%22:%22192x192%22,%22type%22:%22image/jpg%22}]}">

    <style>
        :root { --primary: #e41e26; --blue: #00529B; --green: #25D366; --dark: #222; --orange: #ff9800;}
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; padding-bottom: 320px; -webkit-tap-highlight-color: transparent; }
        
        #age-gate, #role-selection {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); color: white; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; text-align: center; padding: 20px; box-sizing: border-box;
        }
        #role-selection { background: #fff; color: #333; display: none; }

        .gate-btn { width: 100%; max-width: 280px; padding: 18px; margin: 10px; border-radius: 12px; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .role-card { background: #f8f8f8; border: 2px solid #eee; color: var(--dark); margin: 10px; width: 100%; max-width: 300px; padding: 20px; border-radius: 15px; cursor: pointer; }
        .role-card:hover { border-color: var(--primary); background: #fff5f5; }

        header { background: var(--primary); color: white; padding: 15px; text-align: center; padding-top: 30px; }
        .nav-tabs { display: flex; background: white; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; }
        .active-tab { border-bottom: 4px solid var(--primary); color: var(--primary); background: #fff5f5; }

        .container { padding: 15px; }
        .card { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding-bottom:10px; }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-content { padding: 15px; }
        
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .add-btn { background: var(--primary); color: white; border: none; font-weight: bold; }
        .whatsapp-btn { background: var(--green); color: white; border: none; font-weight: bold; padding: 15px; font-size: 1.1rem; }
        .app-btn { background: var(--blue); color: white; border: none; font-weight: bold; padding: 15px; font-size: 1.1rem; margin-top: 10px; }

        .tracking-bar { background: #eee; height: 10px; border-radius: 5px; margin: 20px 0; overflow: hidden; }
        .tracking-progress { background: var(--green); height: 100%; width: 5%; transition: width 1s; }

        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border-radius: 15px; width: 85%; text-align: center; max-height: 80vh; overflow-y: auto; }
        .modal-btn { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 8px; margin: 5px; font-weight: bold; width: 100%; }

        #admin-page, #driver-page { display: none; }
        .driver-card { background: #fff; padding: 15px; margin-top: 12px; border-radius: 10px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 8px solid var(--blue); }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; text-transform: uppercase; margin-top: 5px; }
        
        .order-card { background: #fffbe6; padding: 15px; margin-bottom: 15px; border: 2px solid #ffd54f; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .delivery-card { background: #e3f2fd; padding: 15px; margin-bottom: 15px; border: 2px solid #2196f3; border-radius: 8px; }
        .del-btn { background: #fee; color: #c00; border: 1px solid #fcc; font-size: 11px; padding: 5px; margin-top: 10px; cursor: pointer; border-radius: 4px; width: auto; display: inline-block; }
        
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0px rgba(37, 211, 102, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(37, 211, 102, 0); }
            100% { box-shadow: 0 0 0 0px rgba(37, 211, 102, 0); }
        }
        .new-task-highlight { animation: pulse-border 2s infinite; border: 3px solid var(--green) !important; }

        .float-chat {
            position: fixed; bottom: 180px; right: 20px; background: var(--green);
            color: white; width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; text-decoration: none;
            font-size: 30px; font-weight: bold;
        }

        .cart-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        .cart-del { color: var(--primary); border: none; background: none; width: auto; padding: 0; margin: 0; font-size: 12px; cursor: pointer; font-weight: bold; }
        .order-summary-box { background: #fffde7; padding: 10px; border-radius: 8px; border: 1px solid #ffd54f; margin: 10px 0; font-size: 0.9rem; }
        
        .assign-area { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; }
        
        #install-banner {
            display: none; position: fixed; bottom: 20px; left: 10px; right: 10px;
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 10001;
            border-top: 4px solid var(--primary);
        }
        .forgot-link { font-size: 14px; color: var(--blue); text-decoration: underline; cursor: pointer; display: block; margin-top: 10px; }

        /* PROFESSIONAL NOTIFICATION UI - UPDATED */
        #verifyNotify {
            display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 400px; background: white; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); border-radius: 16px; z-index: 20000;
            padding: 20px; animation: slideDown 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border-top: 5px solid var(--primary);
        }
        @keyframes slideDown { from { top: -150px; opacity: 0; } to { top: 20px; opacity: 1; } }
        .verify-pin-box { background: #f0f0f0; font-size: 24px; font-weight: bold; text-align: center; padding: 15px; margin: 15px 0; border-radius: 12px; border: 2px dashed var(--blue); letter-spacing: 4px; color: var(--blue); position: relative; }
        .copy-tag { position: absolute; right: 8px; bottom: 4px; font-size: 9px; color: var(--green); font-weight: bold; }

        /* DRIVER SPECIFIC BUTTONS */
        .driver-action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-arrive { background: var(--orange); color: white; border: none; font-weight: bold; padding: 16px; border-radius: 8px; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3); cursor: pointer; }
        .btn-delivered { background: var(--green); color: white; border: none; font-weight: bold; padding: 12px; border-radius: 8px; }
        .btn-failed { background: var(--primary); color: white; border: none; font-weight: bold; padding: 12px; border-radius: 8px; }

        /* APPROVAL CARD */
        .approval-card { background: #fff5f5; border: 1px solid var(--primary); padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        
        /* NEW DEBT STYLES */
        .debt-alert { background: #fff3f3; border: 2px solid #f44336; padding: 20px; border-radius: 15px; text-align: center; margin-top: 20px; }
        .debt-amount { font-size: 2rem; font-weight: bold; color: #f44336; margin: 10px 0; }
    </style>
</head>
<body onload="checkAutoLogin()">

<div id="verifyNotify">
    <div style="display:flex; align-items:center; gap:15px; margin-bottom: 15px;">
        <div id="notifyIcon" style="background:var(--primary); color:white; width:45px; height:45px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size: 24px;">üîî</div>
        <div style="flex:1;">
            <strong id="notifyHeader" style="font-size: 1.1rem; color: #333;">System Alert</strong><br>
            <span id="notifySub" style="color:#666; font-size: 14px; line-height: 1.4;">Notification details here.</span>
        </div>
        <button onclick="closeVerifyNotify()" style="border:none; background:#eee; width:30px; height:30px; border-radius:50%; font-size:18px; color:#666; cursor:pointer;">√ó</button>
    </div>
    <div id="forgotPinInputArea" style="margin-top:10px; display:none;">
        <input type="tel" id="forgotPhoneInput" placeholder="Enter Registered Phone Number">
        <button onclick="sendForgotVerification()" style="background:var(--blue); color:white; border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold;">RECOVER PIN</button>
    </div>
    <div class="verify-pin-box" id="pinOutput" style="display:none;" onclick="copyPin()">
        0000
        <span class="copy-tag">TAP TO COPY</span>
    </div>
    <button id="notifyActionBtn" onclick="closeVerifyNotify()" style="display:none; background:var(--primary); color:white; border:none; padding:14px; width:100%; border-radius:10px; font-weight:bold; font-size:1rem; cursor:pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">DISMISS ALERT</button>
</div>

<div id="install-banner">
    <div style="display:flex; align-items:center; gap:10px;">
        <img src="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg" width="50" style="border-radius:8px;">
        <div>
            <strong>Install App</strong><br>
            <small>Add to your home screen for fast access.</small>
        </div>
    </div>
    <button class="add-btn" id="install-btn" style="margin-top:10px;">INSTALL NOW</button>
</div>

<div id="age-gate">
    <h1 style="color:var(--primary);">STOP</h1>
    <h2>AGE VERIFICATION</h2>
    <p>This service is strictly for people aged 18 and older.</p>
    <button class="gate-btn" style="background:var(--green); color:white;" onclick="verifyAge()">YES, I AM 18+</button>
    <button class="gate-btn" style="background:var(--primary); color:white;" onclick="exitSite()">NO, EXIT</button>
</div>

<div id="role-selection">
    <h2 style="color:var(--primary); margin-bottom:5px;">SA Delivery Portal</h2>
    <p style="margin-bottom:25px;">Please select your role to continue</p>
    
    <div class="role-card" onclick="selectRole('customer')">
        <h3 style="margin:0; color:var(--primary);">üõçÔ∏è Customer</h3>
        <small>Order pills & track delivery</small>
    </div>

    <div class="role-card" onclick="selectRole('driver')">
        <h3 style="margin:0; color:var(--blue);">üöö Driver</h3>
        <small>Login or Register as a Driver</small>
    </div>

    <div class="role-card" onclick="selectRole('admin')">
        <h3 style="margin:0; color:var(--dark);">‚öôÔ∏è Admin / Staff</h3>
        <small>Management & Dispatch</small>
    </div>
</div>

<header>
    <h1>SA Abortion Pills Delivery</h1>
    <p>Fast Delivery to Villages & Cities</p>
</header>

<a href="https://wa.me/27632010938?text=Hi, I need help with my order." class="float-chat" target="_blank">üí¨</a>

<div class="nav-tabs">
    <div class="tab active-tab" id="tab-shop-btn" onclick="showPage('shop')">Menu</div>
    <div class="tab" id="tab-check-btn" onclick="showPage('checkout')">My Cart</div>
    <div class="tab" id="tab-track-btn" style="display:none;" onclick="showPage('tracking')">Track Order</div>
    <div class="tab" onclick="resetRoleSelection()">Switch Role</div>
</div>

<div id="shop-page" class="container">
    <div class="card"><img src="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg"><div class="card-content"><h3>1 Week - 4 Weeks Pills</h3><div style="color:var(--blue); font-weight:bold; font-size:1.2rem;">R 650.00</div><button class="add-btn" onclick="addToCart('1-4 Weeks Pills', 650)">Add to Order</button></div></div>
    <div class="card"><img src="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg"><div class="card-content"><h3>2 Months Pills</h3><div style="color:var(--blue); font-weight:bold; font-size:1.2rem;">R 750.00</div><button class="add-btn" onclick="addToCart('2 Months Pills', 750)">Add to Order</button></div></div>
    <div class="card"><img src="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg"><div class="card-content"><h3>3 Months Pills</h3><div style="color:var(--blue); font-weight:bold; font-size:1.2rem;">R 950.00</div><button class="add-btn" onclick="addToCart('3 Months Pills', 950)">Add to Order</button></div></div>
    <div class="card"><img src="https://i.ibb.co/5Hk2xDP/FB-IMG-1649676834315.jpg"><div class="card-content"><h3>4 Months Pills</h3><div style="color:var(--blue); font-weight:bold; font-size:1.2rem;">R 1200.00</div><button class="add-btn" onclick="addToCart('4 Months Pills', 1200)">Add to Order</button></div></div>
</div>

<div id="checkout-page" class="container" style="display:none;">
    <div class="card" style="padding:15px;">
        <h3 style="color:var(--primary); margin-top:0;">Your Selection</h3>
        <div id="cart-list">Your cart is empty.</div>
        <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
        <h3 style="color:var(--primary);">Delivery Details</h3>
        <select id="province" onchange="updateVillages('village')">
            <option value="">-- Choose Province --</option>
            <option value="Gauteng">Gauteng</option>
            <option value="North West">North West</option>
            <option value="Free State">Free State</option>
            <option value="Western Cape">Western Cape</option>
            <option value="KZN">KZN</option>
        </select>
        <select id="village"><option value="">-- Area --</option></select>
        <input type="text" id="custName" placeholder="Your Full Name">
        <input type="tel" id="custPhone" placeholder="Phone Number (WhatsApp)">
        <input type="text" id="custAddress" placeholder="Full Delivery Address">
        <select id="payMethod">
            <option value="Cash on Delivery">Cash on Delivery</option>
            <option value="Capitec Bank">Capitec Transfer (2033037351)</option>
        </select>
    </div>
</div>

<div id="tracking-page" class="container" style="display:none;">
    <div id="tracking-content" class="card" style="padding:15px;">
        <h3 style="color:var(--blue);">Live Order Status</h3>
        <div id="tracking-order-number" style="font-weight:bold; color:var(--primary); margin-bottom:10px;">Order ID: Loading...</div>
        <div id="order-items-summary" class="order-summary-box">Loading order details...</div>
        <p id="status-text"><strong>Status:</strong> Processing Order...</p>
        <div class="tracking-bar"><div id="progress-line" class="tracking-progress"></div></div>
        
        <div id="driver-info" style="margin-top:20px; padding:15px; border:2px solid var(--blue); border-radius:8px; display:none; background: #f0f7ff;">
            <p><strong>üöö Your Order is being delivered by:</strong></p>
            <p style="font-size: 1.1rem; margin-bottom: 5px;"><strong id="assigned-driver-name">Searching...</strong></p>
            <p><strong>üìû Driver Phone:</strong> <span id="assigned-driver-phone-display" style="font-weight:bold;">---</span></p>
            
            <a id="cust-to-driver-wa" href="#" target="_blank" style="text-decoration:none;">
                <button style="background:var(--green); color:white; border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold; margin:10px 0; cursor:pointer;">
                    üí¨ CHAT WITH DRIVER (WhatsApp)
                </button>
            </a>

            <p id="driver-received-msg" style="color:var(--green); font-weight:bold; font-size: 13px; display:none;">‚úÖ Driver has acknowledged your order!</p>
            <hr>
            <button onclick="finishOrder()" style="background:var(--green); color:white; border:none; padding:15px; width:100%; border-radius:8px; font-weight:bold; cursor:pointer;">Order Delivered ‚úÖ</button>
        </div>
    </div>

    <div id="order-complete-view" class="card" style="padding:30px; display:none; text-align:center;">
        <h2 style="color:var(--green);">Order Completed! üéâ</h2>
        <p>Thank you for using our service. Your order has been successfully delivered.</p>
        <button onclick="returnToMenu()" style="background:var(--blue); color:white; border:none; padding:15px; width:100%; border-radius:8px; font-weight:bold; cursor:pointer;">Order Now / Return Home</button>
    </div>
</div>

<div id="admin-page" class="container">
    <button onclick="resetRoleSelection()" style="background:#444; color:white;">‚Üê Back to Selection</button>
    <h2 style="color:var(--primary);">Admin Dashboard</h2>

    <h3 style="color:var(--primary);">0. Driver Cash Settlements</h3>
    <div id="debt-clearance-list" style="background:#e8f5e9; padding:15px; border-radius:10px; border:1px solid var(--green); margin-bottom:20px;">
        Checking for payments...
    </div>
    
    <h3 style="color:var(--primary);">1. New Customer Orders</h3>
    <div id="live-orders-list">No new orders.</div>
    <hr>
    
    <h3 style="color:var(--blue);">2. Active Deliveries (En Route)</h3>
    <div id="active-deliveries-list" style="background:#fff; border-radius:10px; padding:10px; border:1px solid #ddd;">Looking for active deliveries...</div>
    <hr>

    <h3 style="color:var(--orange);">3. Driver Approval Requests</h3>
    <div id="driver-approval-list" style="background:#fff3e0; padding:10px; border-radius:10px;">Checking for requests...</div>
    <hr>
    
    <h3 style="color:var(--dark);">4. Driver Management</h3>
    <div style="background:#f0f7ff; padding:15px; border-radius:10px; border:1px solid #cce3ff;">
        <input type="text" id="driverName" placeholder="Manual Add Driver Name">
        <input type="text" id="driverPhone" placeholder="WhatsApp Number">
        <select id="adminProvince" onchange="updateVillages('adminVillage')">
            <option value="">-- Province --</option>
            <option value="Gauteng">Gauteng</option>
            <option value="North West">North West</option>
            <option value="Free State">Free State</option>
            <option value="Western Cape">Western Cape</option>
            <option value="KZN">KZN</option>
        </select>
        <select id="adminVillage"><option value="">-- Area --</option></select>
        <button onclick="saveDriver()" style="background:var(--green); color:white; font-weight:bold;">Register Driver</button>
    </div>
    <div id="driver-list" style="margin-top: 20px;"></div>
</div>

<div id="driver-page" class="container">
    <button onclick="driverLogout()" style="background:#444; color:white;">‚Üê Logout</button>
    <h2 style="color:var(--blue);">Driver Portal</h2>
    
    <p>Welcome, <span id="portal-driver-name">Driver</span></p>

    <div id="driver-debt-screen" class="debt-alert" style="display:none;">
        <h2 style="margin-top:0;">üõë PAYMENT REQUIRED</h2>
        <p>You delivered a Cash on Delivery order. You must pay 50% of the item price to Admin to continue.</p>
        <div class="debt-amount" id="pending-debt-display">R 0.00</div>
        <div style="background:white; padding:15px; border-radius:10px; text-align:left; border:1px solid #ddd;">
            <strong>BANK DETAILS:</strong><br>
            Bank: Capitec<br>
            Account: 2033037351<br>
            Reference: Your Name
        </div>
        <p style="font-weight:bold; color:var(--primary); margin-top:15px;">Send proof of payment/slip image to Admin via WhatsApp to get more orders.</p>
        <button onclick="window.open('https://wa.me/27632010938?text=I have paid my delivery commission. Here is the proof.', '_blank')" style="background:var(--green); color:white; font-weight:bold;">SEND PROOF OF PAYMENT</button>
    </div>

    <div id="assigned-task-card" class="card" style="padding:15px; border-left: 10px solid var(--green); display:none;">
        <h3 style="color:var(--green);">Active Task</h3>
        <div id="task-details"></div>
        
        <button id="driver-acknowledge-btn" style="background:var(--blue); color:white; margin-bottom:10px;">üì≤ Accept Order</button>
        
        <button id="driver-arrive-btn" class="btn-arrive" style="display:none; width:100%; margin-bottom:10px;" onclick="notifyArrival()">üöÄ I HAVE ARRIVED</button>
        
        <div id="delivery-final-actions" style="display:none;" class="driver-action-grid">
            <button class="btn-delivered" onclick="processDriverDelivery('delivered')">‚úÖ DELIVERED</button>
            <button class="btn-failed" onclick="processDriverDelivery('failed')">‚ùå NOT DELIVERED</button>
        </div>

        <button id="map-link-btn" style="background:var(--blue); color:white;">üìç Open in Google Maps</button>
        <p style="font-size:12px; color:#666; margin-top:10px;">Contact Customer via WhatsApp:</p>
        <button id="cust-whatsapp-btn" style="background:var(--green); color:white;">üí¨ Chat with Customer</button>
    </div>

    <div id="no-task-msg" style="text-align:center; padding:50px; color:#999;">
        <h3>No active tasks.</h3>
        <p>Refresh this page when you receive a notification.</p>
    </div>
</div>

<div id="footer-controls" style="position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); box-sizing: border-box; z-index: 500; display: none;">
    <div id="cart-total" style="font-weight: bold; margin-bottom: 10px; font-size: 1.1rem;">Total: R 0.00</div>
    <button class="whatsapp-btn" style="width:100%;" onclick="sendOrder()">Confirm Order via WhatsApp</button>
    <button class="app-btn" style="width:100%;" onclick="orderViaApp()">Order Now</button>
</div>

<div id="customModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--primary);">Added!</h3>
        <button class="modal-btn" onclick="showPage('checkout'); closeModal();">Go to My Cart</button>
        <button class="modal-btn" style="background:#eee; color:#333;" onclick="closeModal()">Continue Shopping</button>
    </div>
</div>

<div id="loginModal" class="modal">
    <div class="modal-content">
        <h3 id="loginTitle">Portal Login</h3>
        <input type="tel" id="loginPhoneInput" placeholder="WhatsApp Phone Number">
        <input type="password" id="adminPinInput" placeholder="Enter Login PIN">
        <button class="modal-btn" onclick="checkAdminLogin()">Login Securely</button>
        
        <div id="customerRegArea" style="display:none; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px;">
            <p>Don't have a PIN?</p>
            <button class="modal-btn" style="background:var(--blue);" onclick="openRegisterModal()">Register for Account</button>
        </div>
        
        <span class="forgot-link" onclick="forgotPin()">Forgot PIN / Password?</span>
        <button class="modal-btn" style="background:#eee; color:#333;" onclick="closeLoginModal()">Cancel</button>
    </div>
</div>

<div id="registerModal" class="modal">
    <div class="modal-content">
        <h3>Driver Registration</h3>
        <p style="font-size:12px; color:gray;">After registering, Admin must approve your account.</p>
        <input type="text" id="regDriverName" placeholder="Full Name">
        <input type="tel" id="regDriverPhone" placeholder="WhatsApp Phone Number">
        <input type="password" id="regDriverPin" placeholder="Create a 4-Digit PIN">

        <select id="regProvince" onchange="updateVillages('regVillage')">
            <option value="">-- Province --</option>
            <option value="Gauteng">Gauteng</option>
            <option value="North West">North West</option>
            <option value="Free State">Free State</option>
            <option value="Western Cape">Western Cape</option>
            <option value="KZN">KZN</option>
        </select>
        <select id="regVillage"><option value="">-- Area --</option></select>
        
        <button id="requestPinBtn" class="modal-btn" style="background:var(--green);" onclick="submitDriverRegistration()">Submit for Approval</button>
        <button class="modal-btn" style="background:#eee; color:#333;" onclick="closeRegisterModal()">Cancel</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // --- APP CORE CONFIG ---
    let notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
    let soundEnabled = false;
    let alarmInterval = null;

    document.addEventListener('click', () => {
        if(!soundEnabled) {
            notificationSound.play().then(() => {
                notificationSound.pause();
                soundEnabled = true;
            }).catch(e => console.log("Sound ready..."));
        }
    }, { once: true });

    function triggerAlert() {
        if (soundEnabled) {
            notificationSound.currentTime = 0;
            notificationSound.play();
            if (alarmInterval) clearInterval(alarmInterval);
            let playCount = 1; 
            alarmInterval = setInterval(() => {
                notificationSound.currentTime = 0;
                notificationSound.play();
                playCount++;
                if (playCount >= 2) {
                    clearInterval(alarmInterval);
                    alarmInterval = null;
                }
            }, 3000); 
        }
        if ("vibrate" in navigator) {
            navigator.vibrate([300, 100, 300, 100, 300]);
        }
    }

    const firebaseConfig = {
      apiKey: "AIzaSyBbmHfC_SvrT4YPkxeaIxF1X-E0JQ_Gl1U",
      authDomain: "sa-abortion-pills.firebaseapp.com",
      databaseURL: "https://sa-abortion-pills-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sa-abortion-pills",
      storageBucket: "sa-abortion-pills.firebasedatabase.app",
      messagingSenderId: "1026604792208",
      appId: "1:1026604792208:web:3d1a993e25e0b6c25d9b15"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const database = firebase.database();

    let cart = [];
    let allDrivers = [];
    let loggedInDriverPhone = null;
    let currentRoleType = 'customer';
    let generatedPin = "";
    let activeTaskID = null;

    // --- CASH PAYMENT LOGIC ---

    function processDriverDelivery(status) {
        if(!activeTaskID) return;
        
        database.ref('orders/' + activeTaskID).once('value', snap => {
            const order = snap.val();
            // If Delivered and Payment was Cash
            if(status === 'delivered' && order.payment === 'Cash on Delivery') {
                // Get numeric total (Remove "Total Order: R ")
                let cleanTotal = order.total.replace(/[^0-9.]/g, '');
                let debt = (parseFloat(cleanTotal) / 2).toFixed(2);
                
                // Set Driver to Unpaid Status
                database.ref('drivers/' + loggedInDriverPhone).update({
                    currentStatus: 'unpaid_debt',
                    pendingDebt: debt
                });
                
                database.ref('orders/' + activeTaskID).update({ status: status });
                showAppNotify("Payment Required", `Order Complete. You must pay R${debt} to continue.`, "var(--primary)");
            } else {
                // Normal delivery or failure
                updateDeliveryStatus(status);
            }
        });
    }

    function fetchDebtRequests() {
        const div = document.getElementById('debt-clearance-list');
        database.ref('drivers').on('value', snap => {
            div.innerHTML = "";
            let count = 0;
            snap.forEach(child => {
                const d = child.val();
                if(d.currentStatus === 'unpaid_debt') {
                    count++;
                    div.innerHTML += `
                        <div style="background:white; padding:10px; border-radius:8px; margin-bottom:10px; border-left:5px solid red;">
                            <strong>${d.name} owes R${d.pendingDebt}</strong><br>
                            Phone: ${d.phone}<br>
                            <button onclick="clearDriverDebt('${d.phone}')" style="background:var(--green); color:white; padding:5px; width:100%; margin-top:5px; border:none; border-radius:5px;">CONFIRM PAYMENT RECEIVED</button>
                        </div>
                    `;
                }
            });
            if(count === 0) div.innerHTML = "No pending payments from drivers.";
        });
    }

    function clearDriverDebt(phone) {
        if(confirm("Confirm that you have received the cash from this driver?")) {
            database.ref('drivers/' + phone).update({
                currentStatus: 'available',
                pendingDebt: null
            });
            showAppNotify("Debt Cleared", "Driver is now active and can receive orders again.", "var(--green)");
        }
    }

    // --- END CASH LOGIC ---

    function showAppNotify(header, msg, color = "var(--primary)", showAction = true) {
        document.getElementById('notifyHeader').innerText = header;
        document.getElementById('notifySub').innerText = msg;
        const notifyEl = document.getElementById('verifyNotify');
        const iconEl = document.getElementById('notifyIcon');
        document.getElementById('forgotPinInputArea').style.display = "none";
        document.getElementById('pinOutput').style.display = "none";
        if (color === 'var(--green)') iconEl.innerHTML = '‚úÖ';
        else if (color === 'var(--orange)') iconEl.innerHTML = 'üöö';
        else iconEl.innerHTML = 'üîî';
        notifyEl.style.borderTop = `5px solid ${color}`;
        iconEl.style.backgroundColor = color;
        document.getElementById('notifyActionBtn').style.backgroundColor = color;
        document.getElementById('notifyActionBtn').innerText = (color === 'var(--green)') ? "CONTINUE" : "DISMISS ALERT";
        document.getElementById('notifyActionBtn').style.display = showAction ? "block" : "none";
        notifyEl.style.display = "block";
        triggerAlert();
    }

    function forgotPin() {
        closeLoginModal();
        showAppNotify("PIN RECOVERY", "Please enter the phone number associated with your account to recover your security PIN.", "var(--blue)", false);
        document.getElementById('forgotPinInputArea').style.display = "block";
    }

    function sendForgotVerification() {
        const phone = document.getElementById('forgotPhoneInput').value;
        if(!phone) return alert("Please enter a phone number.");
        const path = (currentRoleType === 'driver') ? 'drivers/' : 'users/';
        database.ref(path + phone).once('value', (snap) => {
            if(snap.exists()) {
                const pin = snap.val().pin;
                document.getElementById('forgotPinInputArea').style.display = "none";
                document.getElementById('pinOutput').style.display = "block";
                document.getElementById('pinOutput').innerHTML = `${pin}<span class="copy-tag">TAP TO COPY</span>`;
                document.getElementById('notifySub').innerText = "Account Found! Your security PIN is displayed below. Tap to copy and use it to login.";
                document.getElementById('notifyActionBtn').style.display = "block";
            } else {
                showAppNotify("Error", "No account was found with that phone number. Please check the number or register.", "var(--primary)");
            }
        });
    }

    function checkAutoLogin() {
        startAutoManager();
        if (sessionStorage.getItem('ageVerified') === 'true') {
            document.getElementById('age-gate').style.display = 'none';
            document.getElementById('role-selection').style.display = 'flex';
        }
        const savedPhone = localStorage.getItem('driverLoggedInPhone');
        const savedRole = localStorage.getItem('userRole');
        if(savedPhone && savedRole) {
            loggedInDriverPhone = savedPhone;
            currentRoleType = savedRole;
            document.getElementById('age-gate').style.display = 'none';
            document.getElementById('role-selection').style.display = 'none';
            if(currentRoleType === 'driver') showPage('driver');
            else if(currentRoleType === 'admin') showPage('admin');
            else showPage('shop');
        }
        const myOrderId = localStorage.getItem('myOrderID');
        if(myOrderId){
            database.ref('orders/' + myOrderId + '/arrived').on('value', snap => {
                if(snap.val() === true){
                    showAppNotify("DRIVER ARRIVED!", "Your delivery driver is currently outside your location. Please proceed to the delivery point.", "var(--orange)");
                }
            });
        }
        database.ref('orders').on('child_changed', (snapshot) => {
            const order = snapshot.val();
            const savedPhone = localStorage.getItem('driverLoggedInPhone');
            if(order.status === 'dispatched' && order.dPhone === savedPhone && order.driverReceived === false) {
                 showAppNotify("NEW TASK ASSIGNED", "Admin has assigned a new delivery to you. Please check your portal and accept.", "var(--blue)");
            }
        });
        if(savedRole === 'admin') {
            database.ref('orders').on('child_changed', (snapshot) => {
                const order = snapshot.val();
                if(order.driverReceived === true) {
                    showAppNotify("ORDER ACCEPTED", `Driver ${order.dName} has accepted Order ${snapshot.key.substring(snapshot.key.length - 6)}.`, "var(--green)");
                }
            });
        }
    }

    function startAutoManager() {
        database.ref('orders').on('child_added', (snapshot) => {
            const order = snapshot.val();
            const orderId = snapshot.key;
            database.ref('drivers').once('value', (snap) => {
                allDrivers = [];
                snap.forEach(c => allDrivers.push(c.val()));
            });
            if(localStorage.getItem('userRole') === 'admin' && order.status === 'pending') {
                showAppNotify("NEW ORDER RECEIVED", `Order PILLS-${orderId.substring(orderId.length - 6)} is waiting. System will auto-assign in 60s.`, "var(--primary)");
            }
            if(order.status === 'pending') {
                setTimeout(() => {
                    database.ref('orders/' + orderId).once('value', (freshSnap) => {
                        const freshData = freshSnap.val();
                        if(freshData && freshData.status === 'pending') {
                            autoDispatchOrder(orderId, freshData);
                        }
                    });
                }, 60000); 
            }
        });
    }

    function autoDispatchOrder(orderId, orderData) {
        database.ref('drivers').once('value', (snap) => {
            snap.forEach(driverSnap => {
                const driver = driverSnap.val();
                // ONLY DISPATCH TO "AVAILABLE" DRIVERS (Not unpaid)
                if (driver.village === orderData.area && driver.currentStatus === 'available') {
                    database.ref('orders/' + orderId).update({
                        status: 'dispatched',
                        dName: driver.name,
                        dPhone: driver.phone,
                        driverReceived: false,
                        managedBy: 'System Auto-Dispatch'
                    });
                    database.ref('drivers/' + driver.phone).update({ currentStatus: 'delivering' });
                    return true;
                }
            });
        });
    }

    function verifyAge() { 
        sessionStorage.setItem('ageVerified', 'true');
        document.getElementById('age-gate').style.display = 'none'; 
        document.getElementById('role-selection').style.display = 'flex';
    }

    function selectRole(role) {
        currentRoleType = role;
        document.getElementById('role-selection').style.display = 'none';
        if(role === 'customer') {
            document.getElementById('loginTitle').innerText = "Customer Login";
            document.getElementById('customerRegArea').style.display = "block";
            openLoginModal();
        } else if(role === 'driver') {
            document.getElementById('loginTitle').innerText = "Driver Portal Login";
            document.getElementById('customerRegArea').style.display = "block";
            openLoginModal();
        } else if(role === 'admin') {
            document.getElementById('loginTitle').innerText = "Admin Console Access";
            document.getElementById('customerRegArea').style.display = "none";
            openLoginModal();
        }
    }

    function resetRoleSelection() {
        const pages = ['shop-page', 'checkout-page', 'admin-page', 'tracking-page', 'driver-page', 'footer-controls'];
        pages.forEach(p => document.getElementById(p).style.display = 'none');
        document.getElementById('role-selection').style.display = 'flex';
        localStorage.removeItem('driverLoggedInPhone');
        localStorage.removeItem('userRole');
    }

    function exitSite() { window.location.href = "https://google.com"; }

    function driverLogout() {
        localStorage.removeItem('driverLoggedInPhone');
        localStorage.removeItem('userRole');
        loggedInDriverPhone = null;
        resetRoleSelection();
    }

    function showPage(page) {
        document.getElementById('shop-page').style.display = page === 'shop' ? 'block' : 'none';
        document.getElementById('checkout-page').style.display = page === 'checkout' ? 'block' : 'none';
        document.getElementById('admin-page').style.display = page === 'admin' ? 'block' : 'none';
        document.getElementById('tracking-page').style.display = page === 'tracking' ? 'block' : 'none';
        document.getElementById('driver-page').style.display = page === 'driver' ? 'block' : 'none';
        document.getElementById('footer-controls').style.display = (page === 'shop' || page === 'checkout') ? 'block' : 'none';
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active-tab'));
        if(page === 'shop') document.getElementById('tab-shop-btn').classList.add('active-tab');
        if(page === 'checkout') { document.getElementById('tab-check-btn').classList.add('active-tab'); updateCartUI(); }
        if(page === 'tracking') { document.getElementById('tab-track-btn').classList.add('active-tab'); updateTrackingUI(); }
        if(page === 'admin') { fetchDrivers(); fetchLiveOrders(); fetchPendingDrivers(); fetchDebtRequests(); }
        if(page === 'driver') { loadDriverPortal(); }
    }

    function addToCart(n, p) { cart.push({name: n, price: p}); updateTotal(); document.getElementById('customModal').style.display = "block"; }
    function removeFromCart(index) { cart.splice(index, 1); updateTotal(); updateCartUI(); }
    function updateTotal() { const total = cart.reduce((s, i) => s + i.price, 0); document.getElementById('cart-total').innerText = `Total Order: R ${total.toFixed(2)}`; }
    
    function updateCartUI() {
        const list = document.getElementById('cart-list');
        if(cart.length === 0) { list.innerHTML = "Your selection is currently empty."; return; }
        let html = "";
        cart.forEach((item, index) => { html += `<div class="cart-row"><span>${item.name} (R${item.price})</span><button class="cart-del" onclick="removeFromCart(${index})">REMOVE</button></div>`; });
        list.innerHTML = html;
    }

    function closeModal() { document.getElementById('customModal').style.display = "none"; }
    function openLoginModal() { document.getElementById('loginModal').style.display = "block"; }
    function closeLoginModal() { 
        document.getElementById('loginModal').style.display = "none"; 
        const isUserOnPage = document.getElementById('shop-page').style.display === 'block' || 
                            document.getElementById('admin-page').style.display === 'block' || 
                            document.getElementById('driver-page').style.display === 'block';
        if(!isUserOnPage) document.getElementById('role-selection').style.display = 'flex';
    }
    
    function openRegisterModal() { document.getElementById('loginModal').style.display = "none"; document.getElementById('registerModal').style.display = "block"; }
    function closeRegisterModal() { document.getElementById('registerModal').style.display = "none"; document.getElementById('role-selection').style.display = 'flex'; }
    
    function closeVerifyNotify() { 
        document.getElementById('verifyNotify').style.display = "none"; 
        if (alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; }
        notificationSound.pause();
    }

    function copyPin() {
        const pin = document.getElementById('pinOutput').innerText.replace('TAP TO COPY', '').trim();
        navigator.clipboard.writeText(pin);
        showAppNotify("Information Copied", "PIN has been successfully copied to your clipboard.", "var(--green)");
    }

    function submitDriverRegistration() {
        const name = document.getElementById('regDriverName').value;
        const phone = document.getElementById('regDriverPhone').value;
        const pin = document.getElementById('regDriverPin').value;
        const area = document.getElementById('regVillage').value;
        if(!name || !phone || !pin || !area) return showAppNotify("Missing Information", "Please ensure all registration fields are completed before submitting.", "var(--primary)");
        database.ref('pendingDrivers/' + phone).set({
            name, phone, pin, village: area, status: 'pending'
        }).then(() => {
            showAppNotify("Application Submitted", "Your registration has been sent. A site administrator will review and approve your account shortly.", "var(--green)");
            closeRegisterModal();
        });
    }

    function fetchPendingDrivers() {
        const div = document.getElementById('driver-approval-list');
        database.ref('pendingDrivers').on('value', snap => {
            div.innerHTML = "";
            if(!snap.exists()) { div.innerHTML = "No pending approval requests."; return; }
            snap.forEach(child => {
                const d = child.val();
                div.innerHTML += `
                    <div class="approval-card">
                        <strong>${d.name}</strong> (${d.phone})<br>
                        Area: ${d.village}<br>
                        <button onclick="approveDriver('${d.phone}')" style="background:var(--green); color:white; padding:8px; width:48%;">Accept</button>
                        <button onclick="declineDriver('${d.phone}')" style="background:var(--primary); color:white; padding:8px; width:48%;">Decline</button>
                    </div>
                `;
            });
        });
    }

    function approveDriver(phone) {
        database.ref('pendingDrivers/' + phone).once('value', snap => {
            const data = snap.val();
            database.ref('drivers/' + phone).set({
                name: data.name, phone: data.phone, pin: data.pin, village: data.village, currentStatus: 'available'
            }).then(() => {
                database.ref('pendingDrivers/' + phone).remove();
                showAppNotify("Driver Approved", `Account for ${data.name} is now active in the system.`, "var(--green)");
            });
        });
    }

    function declineDriver(phone) { if(confirm("Permanently decline this driver application?")) database.ref('pendingDrivers/' + phone).remove(); }

    function checkAdminLogin() {
        const phone = document.getElementById('loginPhoneInput').value;
        const pin = document.getElementById('adminPinInput').value;
        if(currentRoleType === 'admin') {
            if((pin === "0774" || pin === "0000")) { 
                localStorage.setItem('driverLoggedInPhone', 'admin');
                localStorage.setItem('userRole', 'admin');
                document.getElementById('loginModal').style.display = "none";
                showPage('admin'); 
            } else { showAppNotify("Access Denied", "The Admin PIN provided is incorrect. Please verify your credentials.", "var(--primary)"); }
            return;
        }
        const dbPath = (currentRoleType === 'driver') ? 'drivers/' : 'users/';
        database.ref(dbPath + phone).once('value', (snap) => {
            if(snap.exists() && snap.val().pin === pin) {
                loggedInDriverPhone = phone;
                localStorage.setItem('driverLoggedInPhone', phone);
                localStorage.setItem('userRole', currentRoleType);
                document.getElementById('loginModal').style.display = "none";
                if(currentRoleType === 'driver') showPage('driver');
                else showPage('shop');
            } else {
                showAppNotify("Authentication Failed", "We could not find a matching account or your PIN is incorrect.", "var(--primary)");
            }
        });
    }

    function updateVillages(targetId) {
        let provinceId = 'province';
        if(targetId === 'adminVillage') provinceId = 'adminProvince';
        if(targetId === 'regVillage') provinceId = 'regProvince';
        const province = document.getElementById(provinceId).value;
        const select = document.getElementById(targetId);
        select.innerHTML = '<option value="">-- Area --</option>';
        let areas = [];
        if (province === "Gauteng") { areas = ["Alexandra", "Diepsloot", "Ennerdale", "Johannesburg", "Lenasia (Lenz)", "Midrand", "Modderfontein", "Orange Farm", "Randburg", "Roodepoort", "Sandton", "Soweto", "Alberton", "Bapsfontein", "Bedfordview", "Benoni", "Boksburg", "Brakpan", "Clayville", "Daveyton", "Devon", "Duduza", "Dunnottar", "Edenvale", "Germiston", "Isando", "Katlehong", "Kempton Park", "KwaThema", "Nigel", "Reiger Park", "Springs", "Tembisa", "Thokoza", "Tsakane", "Vosloorus", "Wattville", "Atteridgeville", "Bronberg", "Bronkhorstspruit", "Centurion", "Cullinan", "Ekangala", "Ga-Rankuwa", "Hammanskraal", "Irene", "Mabopane", "Mamelodi", "Pretoria", "Rayton", "Refilwe", "Soshanguve", "Winterveld", "Zithobeni"];
        } else if (province === "North West") { areas = ["Bloemhof", "Brits", "Christiana", "Coligny", "Delareyville", "Ganyesa", "Groot Marico", "Hartbeespoort", "Jan Kempdorp", "Klerksdorp", "Koster", "Lichtenburg", "Mahikeng", "Mogwase", "Mooinooi", "Orkney", "Ottosdal", "Potchefstroom", "Reivilo", "Rustenburg", "Sannieshof", "Schweizer-Reneke", "Stella", "Stilfontein", "Swartruggens", "Taung", "Ventersdorp", "Vryburg", "Wolmaransstad", "Zeerust"];
        } else if (province === "Free State") { areas = ["Bloemfontein", "Heidedal", "Langenhovenpark", "Welkom", "Kroonstad", "Bethlehem", "Phuthaditjhaba", "Sasolburg", "Parys", "Winburg", "Jagersfontein", "Virginia"];
        } else if (province === "Western Cape") { areas = ["Bellville", "Durbanville", "Parow", "Goodwood", "Brackenfell", "Kraaifontein", "Kuils River", "Rondebosch", "Claremont", "Newlands", "Constantia", "Wynberg", "Plumstead", "Kenilworth", "Simon‚Äôs Town", "Fish Hoek", "Muizenberg", "Noordhoek", "Kommetjie", "Scarborough", "Somerset West", "Strand", "Gordon‚Äôs Bay", "Camps Bay", "Hout Bay", "Sea Point", "Green Point", "Llandudno", "Milnerton", "Table View", "Bloubergstrand", "Melkbosstrand", "Atlantis", "Athlone", "Mitchells Plain", "Khayelitsha", "Gugulethu", "Langa", "Nyanga", "Delft"];
        } else if (province === "KZN") { areas = ["Durban", "Amanzimtoti", "Chatsworth", "Hillcrest", "Kloof", "Pinetown", "Phoenix", "Umhlanga", "Umlazi", "Verulam", "Westville", "Tongaat", "Kingsburgh", "Port Shepstone", "Margate", "Scottburgh", "Harding", "Hibberdene", "Pennington", "Port Edward", "Southbroom", "Umzinto", "Shelly Beach", "KwaDukuza (Stanger)", "Ballito", "Mandeni", "Salt Rock", "Maphumulo", "Shakaskraal", "Pietermaritzburg", "Howick", "Hilton", "Richmond", "Mooi River", "Wartburg", "Dalton", "Ixopo", "Kokstad", "Underberg", "Himeville", "Bulwer", "Umzimkhulu", "Newcastle", "Dannhauser", "Charlestown", "Madadeni", "Ladysmith", "Estcourt", "Bergville", "Colenso", "Winterton", "Dundee", "Greytown", "Nquthu", "Pomeroy", "Glencoe", "Ulundi", "Vryheid", "Nongoma", "Pongola", "Paulpietersburg", "Richards Bay", "Empangeni", "Eshowe", "Melmoth", "Mtunzini", "Mkuze", "St Lucia", "Hluhluwe", "Mtubatuba", "Jozini"]; }
        areas.sort().forEach(a => { let o = document.createElement('option'); o.value = a; o.innerText = a; select.appendChild(o); });
    }

    function saveDriver() {
        const name = document.getElementById('driverName').value;
        const phone = document.getElementById('driverPhone').value;
        const area = document.getElementById('adminVillage').value;
        if(name && phone && area) {
            database.ref('drivers/' + phone).once('value', (snap) => {
                if(snap.exists()) showAppNotify("Duplicate Driver", "This phone number is already registered to an existing driver.", "var(--primary)");
                else {
                    database.ref('drivers/' + phone).update({ name, phone, village: area, currentStatus: 'available' });
                    document.getElementById('driverName').value = ""; document.getElementById('driverPhone').value = "";
                    showAppNotify("Driver Registered", "The driver has been manually added to the database.", "var(--green)");
                }
            });
        }
    }

    function fetchDrivers() {
        database.ref('drivers').on('value', (snapshot) => {
            allDrivers = []; const listDiv = document.getElementById('driver-list');
            listDiv.innerHTML = "<h4>Registered Drivers</h4>";
            snapshot.forEach(child => {
                const d = child.val(); allDrivers.push(d);
                let statusColor = d.currentStatus === 'delivering' ? "var(--green)" : (d.currentStatus === 'unpaid_debt' ? "var(--primary)" : "var(--blue)");
                listDiv.innerHTML += `<div class='driver-card' style='border-left: 8px solid ${statusColor};'><strong>${d.name}</strong> (${d.phone})<br><small>Area: ${d.village}</small><br><span class="status-badge" style="background:${statusColor};">${d.currentStatus}</span><button onclick="deleteDriver('${d.phone}')" class='del-btn' style="margin-left:10px;">Remove</button></div>`;
            });
        });
    }

    function deleteDriver(phone) { if(confirm("Permanently remove this driver from the system?")) database.ref('drivers/' + phone).remove(); }

    function fetchLiveOrders() {
        const orderDiv = document.getElementById('live-orders-list');
        const activeDiv = document.getElementById('active-deliveries-list');
        database.ref('orders').on('value', (snapshot) => {
            orderDiv.innerHTML = ""; activeDiv.innerHTML = "";
            let hasNew = false; let hasActive = false;
            if(!snapshot.exists()) return;
            snapshot.forEach((child) => {
                const o = child.val(); const orderId = child.key;
                const shortId = orderId.substring(orderId.length - 6);
                if(o.status === 'dispatched' || o.status === 'delivered' || o.status === 'failed') {
                    hasActive = true;
                    let ack = o.driverReceived ? "<span style='color:green; font-weight:bold;'>‚úÖ DRIVER ACCEPTED ORDER</span>" : "<span style='color:orange;'>‚è≥ Waiting for Acknowledgment</span>";
                    let finalStatus = o.status === 'delivered' ? "‚úÖ DELIVERED" : (o.status === 'failed' ? "‚ùå FAILED" : "üöö EN ROUTE");
                    activeDiv.innerHTML += `<div class="delivery-card"><strong>üì¶ Order ID: PILLS-${shortId}</strong><br><strong>Status: ${finalStatus}</strong><br><strong>üöö Driver: ${o.dName}</strong><br><strong>üõí Items: ${o.items}</strong><br><strong>üí∞ Price: ${o.total}</strong><br>${ack}<hr><small>üìç Area: ${o.area}</small><br><button onclick="deleteOrder('${orderId}')" class="del-btn">Remove Record</button></div>`;
                } else if(o.status === 'pending') {
                    hasNew = true;
                    // Filter drivers to only show those who are NOT in debt
                    let suggestedDriver = allDrivers.find(d => d.village === o.area && d.currentStatus === 'available');
                    let suggestionText = suggestedDriver ? `<div style="color:var(--green); font-size:12px; margin-top:5px;">üí° Suggested: <b>${suggestedDriver.name}</b> (Local & Available)</div>` : `<div style="color:var(--orange); font-size:12px; margin-top:5px;">‚ö†Ô∏è No local driver available in ${o.area}</div>`;
                    let driverOptions = `<option value="">-- Select Near Driver --</option>`;
                    allDrivers.forEach(dr => { 
                        if(dr.currentStatus === 'available') {
                            let isSuggested = (suggestedDriver && dr.phone === suggestedDriver.phone) ? ' (SUGGESTED)' : '';
                            driverOptions += `<option value="${dr.phone}">${dr.name} (${dr.village})${isSuggested}</option>`; 
                        }
                    });
                    let card = document.createElement('div');
                    card.className = "order-card";
                    card.innerHTML = `<div style="background:var(--primary); color:white; padding:5px; border-radius:4px; font-size:12px; margin-bottom:10px;">ORDER ID: PILLS-${shortId}</div><strong>üìç Area: ${o.area}</strong><br><strong>üë§ Customer:</strong> ${o.customer}<br><strong>üì¶ Items:</strong> ${o.items}<br><strong>üí∞ Price:</strong> ${o.total}${suggestionText}<div class="assign-area"><select id="select-${orderId}">${driverOptions}</select><button onclick="dispatchSpecificOrder('${orderId}')" style="background:var(--blue); color:white; width:100%; padding:12px; margin-top:5px; font-weight:bold;">Assign Driver</button></div>`;
                    orderDiv.appendChild(card);
                }
            });
            if(!hasNew) orderDiv.innerHTML = "No new pending orders found.";
            if(!hasActive) activeDiv.innerHTML = "No active delivery processes.";
        });
    }

    function deleteOrder(id) {
        if(confirm("Permanently delete this order record?")) {
            database.ref('orders/' + id).once('value', (snap) => {
                const data = snap.val();
                if(data.dPhone) {
                    // Check if driver was delivering. If so, set back to available. 
                    // If they are 'unpaid_debt', leave them that way.
                    database.ref('drivers/' + data.dPhone).once('value', drSnap => {
                        if(drSnap.val().currentStatus === 'delivering') {
                            database.ref('drivers/' + data.dPhone).update({currentStatus: 'available'});
                        }
                    });
                }
                database.ref('orders/' + id).remove();
            });
        }
    }

    function dispatchSpecificOrder(orderId) {
        const driverPhone = document.getElementById('select-' + orderId).value;
        if(!driverPhone) return;
        const driver = allDrivers.find(d => d.phone === driverPhone);
        database.ref('orders/' + orderId).update({ status: 'dispatched', dName: driver.name, dPhone: driver.phone, driverReceived: false, arrived: false });
        database.ref('drivers/' + driverPhone).update({ currentStatus: 'delivering' });
        showAppNotify("Order Dispatched", `Task successfully assigned to ${driver.name}.`, "var(--green)");
    }

    function loadDriverPortal() {
        if(!loggedInDriverPhone) return;
        database.ref('drivers/' + loggedInDriverPhone).on('value', snap => {
            if(!snap.exists()) return;
            const driver = snap.val();
            document.getElementById('portal-driver-name').innerText = driver.name;
            
            // CHECK FOR DEBT FIRST
            if(driver.currentStatus === 'unpaid_debt') {
                document.getElementById('driver-debt-screen').style.display = 'block';
                document.getElementById('pending-debt-display').innerText = `R ${driver.pendingDebt}`;
                document.getElementById('assigned-task-card').style.display = 'none';
                document.getElementById('no-task-msg').style.display = 'none';
                return;
            } else {
                document.getElementById('driver-debt-screen').style.display = 'none';
            }

            database.ref('orders').orderByChild('dPhone').equalTo(loggedInDriverPhone).on('value', snapOrders => {
                const taskCard = document.getElementById('assigned-task-card');
                const taskDetails = document.getElementById('task-details');
                const ackBtn = document.getElementById('driver-acknowledge-btn');
                const arriveBtn = document.getElementById('driver-arrive-btn');
                const finalActions = document.getElementById('delivery-final-actions');
                let foundTask = false;
                taskDetails.innerHTML = "";
                if(snapOrders.exists()) {
                    snapOrders.forEach(oSnap => {
                        const o = oSnap.val();
                        if(o.status === 'dispatched') {
                            foundTask = true; activeTaskID = oSnap.key;
                            taskDetails.innerHTML = `<p><strong>ID: PILLS-${activeTaskID.substring(activeTaskID.length - 6)}</strong></p><p><strong>Cust:</strong> ${o.customer}</p><p><strong>Addr:</strong> ${o.address}</p><p><strong>Items:</strong> <span style="color:var(--primary); font-weight:bold;">${o.items}</span></p><p><strong>Price Breakdown:</strong> <span style="color:var(--green); font-weight:bold;">${o.total}</span></p><p><strong>Pay Method:</strong> ${o.payment}</p>`;
                            
                            ackBtn.style.display = o.driverReceived ? "none" : "block";
                            arriveBtn.style.display = (o.driverReceived && !o.arrived) ? "block" : "none";
                            finalActions.style.display = (o.driverReceived && o.arrived) ? "grid" : "none";
                            
                            ackBtn.onclick = () => { database.ref('orders/' + oSnap.key).update({ driverReceived: true }); };
                            document.getElementById('map-link-btn').onclick = () => { window.open("https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(o.address + ", " + o.area + ", South Africa"), '_blank'); };
                            document.getElementById('cust-whatsapp-btn').onclick = () => { let cp = o.phone; if(cp.startsWith('0')) cp = '27' + cp.substring(1); window.open(`https://wa.me/${cp}?text=Hi, I am your driver for order PILLS-${activeTaskID.substring(activeTaskID.length - 6)}`, '_blank'); };
                        }
                    });
                }
                taskCard.style.display = foundTask ? 'block' : 'none';
                document.getElementById('no-task-msg').style.display = foundTask ? 'none' : 'block';
            });
        });
    }

    function notifyArrival() {
        if(!activeTaskID) return;
        database.ref('orders/' + activeTaskID).update({ arrived: true }).then(() => {
            showAppNotify("Arrival Confirmed", "The customer has been notified. You can now mark the order as delivered or failed.", "var(--orange)");
        });
    }

    function updateDeliveryStatus(status) {
        if(!activeTaskID) return;
        database.ref('orders/' + activeTaskID).update({ status: status });
        database.ref('drivers/' + loggedInDriverPhone).update({ currentStatus: 'available' });
        showAppNotify("Action Completed", "Order record updated successfully.", status === 'delivered' ? "var(--green)" : "var(--primary)");
    }

    function sendOrder() {
        const o = collectData();
        if(!o.customer || !o.area || cart.length === 0) return showAppNotify("Action Required", "Please fill details and add items.", "var(--primary)");
        const newRef = database.ref('orders').push();
        newRef.set({...o, status: 'pending', timestamp: Date.now()});
        const fullId = "PILLS-" + newRef.key.substring(newRef.key.length - 6);
        localStorage.setItem('myOrderID', newRef.key);
        window.open(`https://wa.me/27632010938?text=New Order: ${fullId}%0AItems: ${o.items}%0APrice: ${o.total}%0APayment: ${o.payment}`, '_blank');
        showPage('tracking'); cart = []; updateTotal();
    }

    function orderViaApp() {
        const o = collectData();
        if(!o.customer || !o.area || cart.length === 0) return showAppNotify("Action Required", "Please fill details and add items.", "var(--primary)");
        const newRef = database.ref('orders').push();
        newRef.set({...o, status: 'pending', timestamp: Date.now()});
        localStorage.setItem('myOrderID', newRef.key);
        showPage('tracking'); cart = []; updateTotal();
        showAppNotify("Order Received", "Tracking your order now.", "var(--green)");
    }

    function collectData() { return { customer: document.getElementById('custName').value, phone: document.getElementById('custPhone').value, address: document.getElementById('custAddress').value, area: document.getElementById('village').value, items: cart.map(i => i.name).join(", "), total: document.getElementById('cart-total').innerText, payment: document.getElementById('payMethod').value }; }

    function updateTrackingUI() {
        const orderId = localStorage.getItem('myOrderID');
        if(!orderId) return;
        database.ref('orders/' + orderId).on('value', (snapshot) => {
            if(snapshot.exists()) {
                const d = snapshot.val();
                document.getElementById('tracking-order-number').innerText = `Order ID: PILLS-${orderId.substring(orderId.length - 6)}`;
                document.getElementById('order-items-summary').innerHTML = `<strong>Items:</strong> ${d.items}<br><strong>Total:</strong> ${d.total}`;
                if(d.status === 'pending') { document.getElementById('progress-line').style.width = "30%"; document.getElementById('status-text').innerHTML = "Status: Waiting for Dispatch..."; }
                else if(d.status === 'dispatched') { 
                    document.getElementById('progress-line').style.width = "90%"; 
                    document.getElementById('status-text').innerHTML = "Status: Driver En Route"; 
                    document.getElementById('driver-info').style.display = 'block'; 
                    document.getElementById('assigned-driver-name').innerText = d.dName; 
                    document.getElementById('assigned-driver-phone-display').innerText = d.dPhone;
                    if(d.driverReceived) document.getElementById('driver-received-msg').style.display = 'block';
                }
            }
        });
    }

    function finishOrder() {
        const id = localStorage.getItem('myOrderID');
        database.ref('orders/' + id).once('value', snap => {
            const data = snap.val();
            // If the driver isn't in debt lock, set them to available
            if(data.exists() && data.dPhone) {
                database.ref('drivers/' + data.dPhone).once('value', drSnap => {
                    if(drSnap.val().currentStatus === 'delivering') {
                        database.ref('drivers/' + data.dPhone).update({ currentStatus: 'available' });
                    }
                });
            }
            localStorage.removeItem('myOrderID');
            document.getElementById('tracking-content').style.display = 'none';
            document.getElementById('order-complete-view').style.display = 'block';
        });
    }

    function returnToMenu() { 
        document.getElementById('tracking-content').style.display = 'block'; 
        document.getElementById('order-complete-view').style.display = 'none'; 
        showPage('shop'); 
    }
    if(localStorage.getItem('myOrderID')) document.getElementById('tab-track-btn').style.display = 'block';
</script>
</body>
</html>
